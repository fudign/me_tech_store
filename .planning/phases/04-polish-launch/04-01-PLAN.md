---
phase: 04-polish-launch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Http/Controllers/ProductController.php
  - app/Http/Controllers/CategoryController.php
  - app/Http/Controllers/Admin/ProductController.php
  - app/Http/Controllers/Admin/CategoryController.php
  - app/Http/Requests/UpdateProductRequest.php
  - app/Http/Requests/UpdateCategoryRequest.php
  - app/Services/SeoService.php
  - resources/views/layouts/app.blade.php
  - resources/views/admin/products/edit.blade.php
  - resources/views/admin/categories/edit.blade.php
  - routes/web.php
  - routes/console.php
  - app/Console/Commands/GenerateSitemap.php
  - composer.json
autonomous: true

must_haves:
  truths:
    - "Every product page displays unique meta title and description in HTML head"
    - "Social media preview shows product image, title, and description when link is shared"
    - "Site generates sitemap.xml accessible at /sitemap.xml with all products and categories"
    - "Robots.txt allows search engines to index site while blocking admin panel"
    - "Admin can edit meta title and meta description for products in SEO tab"
    - "Admin can edit meta title and meta description for categories in SEO tab"
  artifacts:
    - path: "app/Services/SeoService.php"
      provides: "Meta tag generation with automatic templates and manual overrides"
      min_lines: 40
    - path: "app/Console/Commands/GenerateSitemap.php"
      provides: "Sitemap generation from Product and Category models"
      exports: ["handle"]
    - path: "resources/views/layouts/app.blade.php"
      contains: "SEOMeta::generate"
    - path: "resources/views/admin/products/edit.blade.php"
      contains: "meta_title"
    - path: "resources/views/admin/categories/edit.blade.php"
      contains: "meta_title"
  key_links:
    - from: "app/Http/Controllers/ProductController.php"
      to: "app/Services/SeoService.php"
      via: "setSeoTags method call in show()"
      pattern: "SeoService.*setSeoTags"
    - from: "resources/views/layouts/app.blade.php"
      to: "artesaos/seotools"
      via: "SEOMeta facade render"
      pattern: "SEOMeta::generate"
    - from: "app/Console/Commands/GenerateSitemap.php"
      to: "public/sitemap.xml"
      via: "writeToFile()"
      pattern: "writeToFile.*sitemap"
---

<objective>
Implement comprehensive SEO optimization for search engine visibility and social media sharing.

Purpose: Enable Google and Yandex to properly index all product pages, categories, and generate rich social media previews. Administrator can customize meta tags per product and category for better search rankings.

Output: Fully functional SEO system with auto-generated meta tags, sitemap.xml updated daily, robots.txt protecting admin panel, and admin interface for meta tag editing.
</objective>

<execution_context>
@C:\Users\user\Desktop\mi_tech\.planning\workflows\execute-plan.md
@C:\Users\user\Desktop\mi_tech\.planning\templates\summary.md
</execution_context>

<context>
@C:\Users\user\Desktop\mi_tech\.planning\PROJECT.md
@C:\Users\user\Desktop\mi_tech\.planning\ROADMAP.md
@C:\Users\user\Desktop\mi_tech\.planning\STATE.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\04-polish-launch\04-CONTEXT.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\04-polish-launch\04-RESEARCH.md

## Prior Phase Context

artesaos/seotools package already installed (01-01).
Database columns meta_title, meta_description exist in products and categories tables (01-01).
Slug-based routing implemented with spatie/laravel-sluggable (01-01).
Product and Category models with is_active filtering (01-01).
Admin product edit form has 4-tab structure: Basic, Images, Attributes, SEO (03-01).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sitemap package and create SEO service</name>
  <files>
    composer.json
    app/Services/SeoService.php
  </files>
  <action>
Install spatie/laravel-sitemap package:
```bash
composer require spatie/laravel-sitemap
```

Create SeoService at app/Services/SeoService.php:
- Method setSeoTags($model) that accepts Product or Category
- For products:
  * Meta title: Use $product->meta_title if set, otherwise generate: "Купить {name} - цена {formatted_price} в Бишкеке | Xiaomi Store"
  * Meta description: Use $product->meta_description if set, otherwise generate from top 3 attributes: "{name} - {attr1}, {attr2}, {attr3}. ✓ Официальная гарантия ✓ Доставка по Кыргызстану"
  * Canonical URL: route('products.show', $product)
  * Keywords: ['Xiaomi', $product->name, 'купить', 'Бишкек']
- For categories:
  * Meta title: Use $category->meta_title if set, otherwise: "{name} Xiaomi - купить в Бишкеке | Xiaomi Store"
  * Meta description: Use $category->meta_description if set, otherwise: "Купить {name} Xiaomi в Бишкеке. Большой выбор, официальная гарантия, доставка по Кыргызстану."
  * Canonical URL: route('categories.show', $category)
- Call SEOMeta::setTitle(), setDescription(), setCanonical(), addKeyword()
- Call OpenGraph::setTitle(), setDescription(), setUrl(), addImage() (use main_image if product)
- For products: Add JsonLd Product schema with name, description, image, offers (price, currency KGS, availability based on stock > 0)
- Use artesaos/seotools facades (already installed)

Why this approach: Automatic generation ensures all pages have SEO tags even without manual input. Template-based generation follows Google best practices (50-60 char titles, 150-160 char descriptions). Manual override gives admin control for important products.
  </action>
  <verify>
```bash
composer show spatie/laravel-sitemap
cat app/Services/SeoService.php | grep -E "(setSeoTags|SEOMeta|OpenGraph|JsonLd)"
```
SeoService should have setSeoTags method using SEOMeta, OpenGraph, JsonLd facades.
  </verify>
  <done>
spatie/laravel-sitemap installed in composer.json.
SeoService.php exists with setSeoTags method handling Product and Category models.
Service uses artesaos/seotools facades for meta tag generation.
Automatic templates defined per 04-CONTEXT.md specifications.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SEO tags into controllers and layout</name>
  <files>
    app/Http/Controllers/ProductController.php
    app/Http/Controllers/CategoryController.php
    resources/views/layouts/app.blade.php
  </files>
  <action>
Update ProductController::show():
- Inject SeoService via constructor
- Call $seoService->setSeoTags($product) before returning view
- Keep existing eager loading ($product->load('categories', 'attributes'))

Update CategoryController::show():
- Inject SeoService via constructor
- Call $seoService->setSeoTags($category) before returning view
- Keep existing product query with pagination

Update resources/views/layouts/app.blade.php in <head> section:
- After existing <meta charset> and viewport tags, add:
```blade
{!! SEOMeta::generate() !!}
{!! OpenGraph::generate() !!}
{!! Twitter::generate() !!}
{!! JsonLd::generate() !!}
```
- Use @php use Artesaos\SEOTools\Facades\SEOMeta; @endphp at top if needed
- Maintain existing Tailwind CSS and Alpine.js script tags

Why inject in controller (not middleware): Different models need different SEO logic. Controller has access to loaded model with relationships. Per-action control allows customization (e.g., homepage vs product page).
  </action>
  <verify>
```bash
grep -n "setSeoTags" app/Http/Controllers/ProductController.php app/Http/Controllers/CategoryController.php
grep -n "SEOMeta::generate" resources/views/layouts/app.blade.php
```
Both controllers call setSeoTags before view.
Layout renders SEO meta tags in head section.
  </verify>
  <done>
ProductController and CategoryController inject SeoService and call setSeoTags.
Storefront layout (app.blade.php) renders SEOMeta, OpenGraph, Twitter, JsonLd in head.
SEO tags now appear on all product and category pages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add SEO tab to admin product and category editors</name>
  <files>
    resources/views/admin/products/edit.blade.php
    resources/views/admin/categories/edit.blade.php
    app/Http/Requests/UpdateProductRequest.php
    app/Http/Requests/UpdateCategoryRequest.php
    app/Http/Controllers/Admin/ProductController.php
    app/Http/Controllers/Admin/CategoryController.php
  </files>
  <action>
**For Products:**

Update admin product edit form (already has 4-tab structure from 03-01):
- In tab navigation, SEO tab already exists (per 03-01 decision)
- In SEO tab content section, add:
  * Meta Title input: name="meta_title", maxlength="60", value from old() or $product->meta_title, placeholder="Оставьте пустым для автогенерации"
  * Helper text: "Оптимально: 50-60 символов. Авто: Купить {name} - цена {price} в Бишкеке"
  * Meta Description textarea: name="meta_description", maxlength="160", rows="3", placeholder="Оставьте пустым для автогенерации"
  * Helper text: "Оптимально: 150-160 символов. Включите ключевые характеристики."
  * URL slug input: name="slug", value from old() or $product->slug, readonly (generated by Spatie Sluggable)
  * Helper text: "Генерируется автоматически из названия товара"
  * Preview box styled with bg-gray-50, showing:
    - Title in text-blue-600 (60 char limit with ellipsis)
    - URL in text-green-700 (config('app.url')/products/{slug})
    - Description in text-gray-600 (160 char limit)
- Use Tailwind CSS classes matching existing admin panel styles
- Alpine.js already active for tabs (from 03-01)

Update UpdateProductRequest validation:
- Add 'meta_title' => 'nullable|string|max:60'
- Add 'meta_description' => 'nullable|string|max:160'
- Keep existing product field validation

Update Admin/ProductController::update():
- No changes needed - $request->validated() already passes meta fields to $product->update()
- Ensure meta_title, meta_description in Product model's $fillable array

**For Categories (SEO-07 requirement):**

Update admin category edit form (resources/views/admin/categories/edit.blade.php):
- Add SEO section (may not have tabs like products - use simple section)
- Add same fields as products:
  * Meta Title input: name="meta_title", maxlength="60", value from old() or $category->meta_title
  * Helper text: "Оптимально: 50-60 символов. Авто: {name} Xiaomi - купить в Бишкеке"
  * Meta Description textarea: name="meta_description", maxlength="160", rows="3"
  * Helper text: "Оптимально: 150-160 символов"
  * URL slug input: name="slug", readonly
  * Preview box showing SERP appearance
- Wrap in card/section with heading "SEO настройки"

Create UpdateCategoryRequest validation if doesn't exist:
- Add 'meta_title' => 'nullable|string|max:60'
- Add 'meta_description' => 'nullable|string|max:160'
- If no form request exists, add validation directly in Admin/CategoryController::update()

Update Admin/CategoryController::update():
- Ensure meta_title, meta_description accepted in request and passed to $category->update()
- Add to Category model's $fillable array

Why 60/160 char limits: Google displays ~50-60 chars for titles, ~150-160 for descriptions. Longer content gets truncated with "..." in search results.

Why category SEO matters (SEO-07): Category pages are important landing pages from search. "Xiaomi смартфоны купить Бишкек" should land on category page with optimized meta tags.
  </action>
  <verify>
```bash
grep -A 10 "Meta Title" resources/views/admin/products/edit.blade.php | head -15
grep -A 10 "Meta Title" resources/views/admin/categories/edit.blade.php | head -15
grep "meta_title\|meta_description" app/Http/Requests/UpdateProductRequest.php
grep "meta_title\|meta_description" app/Http/Requests/UpdateCategoryRequest.php
grep "meta_title" app/Models/Product.php app/Models/Category.php
```
SEO tab contains meta_title and meta_description inputs in both product and category editors.
UpdateProductRequest and UpdateCategoryRequest validate both fields as nullable with max lengths.
Product and Category models include meta fields in $fillable.
  </verify>
  <done>
Admin product editor has functional SEO tab with meta title and description inputs.
Admin category editor has SEO section with same meta fields (SEO-07 requirement).
Both forms include Google SERP preview showing how they will appear in search results.
Validation enforces character limits per Google recommendations.
Admin can leave fields empty to use automatic generation or override with custom text.
  </done>
</task>

<task type="auto">
  <name>Task 4: Generate sitemap.xml and robots.txt</name>
  <files>
    app/Console/Commands/GenerateSitemap.php
    routes/console.php
    routes/web.php
  </files>
  <action>
Create artisan command app/Console/Commands/GenerateSitemap.php:
- Signature: sitemap:generate
- Description: "Generate sitemap.xml from active products and categories"
- In handle() method:
  * Use Spatie\Sitemap\Sitemap::create()
  * Add homepage: Url::create('/')->setLastModificationDate(now())->setPriority(1.0)->setChangeFrequency(Url::CHANGE_FREQUENCY_DAILY)
  * Add categories: Category::where('is_active', true)->get(), priority 0.8, weekly change frequency
  * Add products: Product::where('is_active', true)->get(), priority 0.6, weekly change frequency
  * Implement Sitemapable interface on Product and Category models:
    - toSitemapTag() returns Url::create(route('products.show', $this)) with lastModificationDate from updated_at
  * Call $sitemap->writeToFile(public_path('sitemap.xml'))
  * Cache::put('sitemap_generated_at', now(), now()->addDay())
- Import: use Spatie\Sitemap\Sitemap, Spatie\Sitemap\Tags\Url, Spatie\Sitemap\Contracts\Sitemapable

Register command in app/Providers/AppServiceProvider.php $commands array if needed (Laravel auto-discovers in app/Console/Commands).

Schedule daily generation in routes/console.php:
```php
use Illuminate\Support\Facades\Schedule;
Schedule::command('sitemap:generate')->daily();
```

Add sitemap route in routes/web.php:
```php
Route::get('sitemap.xml', function () {
    return response()->file(public_path('sitemap.xml'), [
        'Content-Type' => 'application/xml',
    ]);
});
```

Add robots.txt route in routes/web.php:
```php
Route::get('robots.txt', function () {
    $content = app()->environment('production')
        ? "User-agent: *\nDisallow: /admin\nDisallow: /api\nDisallow: /cart\nDisallow: /checkout\n\nSitemap: " . url('sitemap.xml')
        : "User-agent: *\nDisallow: /\n";
    return response($content, 200)->header('Content-Type', 'text/plain');
});
```

Why dynamic robots.txt: Blocks staging/dev from search engines automatically. Production allows indexing except admin/cart. Sitemap URL included for search engine discovery.

Why scheduled generation: Products change frequently. Daily regeneration ensures sitemap stays current without manual intervention. 24-hour cache prevents excessive file writes.
  </action>
  <verify>
```bash
php artisan sitemap:generate
ls -lh public/sitemap.xml
curl http://localhost:8000/sitemap.xml | head -20
curl http://localhost:8000/robots.txt
```
Sitemap.xml created with products and categories.
sitemap.xml route returns XML content.
robots.txt route returns text with Disallow rules and Sitemap URL.
  </verify>
  <done>
sitemap:generate command generates sitemap.xml from active products and categories.
Command scheduled to run daily via Laravel scheduler.
Sitemap accessible at /sitemap.xml route serving static file.
Robots.txt accessible at /robots.txt with environment-based rules (blocks dev, allows production).
Product and Category models implement Sitemapable interface with proper priority and change frequency.
  </done>
</task>

</tasks>

<verification>
1. Visit product page in browser, view source: meta tags present with title, description, og:image
2. Visit category page, view source: meta tags present with custom or auto-generated title/description
3. Share product link in Facebook/Twitter debugger: preview shows correct image and text
4. Visit /sitemap.xml: XML file with all active products and categories, lastmod dates
5. Visit /robots.txt: Disallow rules for /admin, /api, /cart; Sitemap URL present
6. Edit product in admin, go to SEO tab: meta title and description inputs with preview box
7. Edit category in admin: SEO section with meta title and description inputs
8. Save product with custom meta tags, view product page source: custom tags appear instead of auto-generated
9. Save category with custom meta tags, view category page source: custom tags appear
</verification>

<success_criteria>
- All product pages render unique meta title and description in HTML head
- All category pages render unique meta title and description in HTML head
- OpenGraph tags enable rich social media previews with product image
- JsonLd Product schema provides structured data for Google rich snippets
- sitemap.xml updates daily with all active products and categories
- robots.txt blocks admin panel while allowing storefront indexing
- Admin can edit meta tags per product with character count guidance (SEO-06)
- Admin can edit meta tags per category with character count guidance (SEO-07)
- Empty meta fields fall back to automatic template-based generation
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-launch/04-01-SUMMARY.md`
</output>

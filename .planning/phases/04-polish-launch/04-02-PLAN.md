---
phase: 04-polish-launch
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - composer.json
  - config/image.php
  - app/Services/ImageService.php
  - app/View/Components/ProductImage.php
  - resources/views/components/product-image.blade.php
  - resources/views/products/index.blade.php
  - resources/views/products/show.blade.php
  - resources/views/home.blade.php
autonomous: true

must_haves:
  truths:
    - "Product images load in WebP format for modern browsers with JPEG fallback"
    - "Images load lazily (below-the-fold images don't download until user scrolls)"
    - "Catalog displays thumbnail images (200x200) instead of full-size originals"
    - "Product detail page shows medium images (600x600) for main display"
    - "Images are generated on first request and cached for subsequent requests"
  artifacts:
    - path: "app/Services/ImageService.php"
      provides: "On-the-fly WebP/JPEG thumbnail generation with caching"
      min_lines: 80
    - path: "app/View/Components/ProductImage.php"
      provides: "Blade component wrapping <picture> element"
      exports: ["render"]
    - path: "resources/views/components/product-image.blade.php"
      contains: "<picture>"
    - path: "config/image.php"
      provides: "Intervention Image configuration"
  key_links:
    - from: "resources/views/products/index.blade.php"
      to: "x-product-image component"
      via: "Blade component call"
      pattern: "<x-product-image"
    - from: "app/View/Components/ProductImage.php"
      to: "app/Services/ImageService.php"
      via: "getOptimizedImage method call"
      pattern: "ImageService.*getOptimizedImage"
    - from: "resources/views/components/product-image.blade.php"
      to: "browser native lazy loading"
      via: 'loading="lazy" attribute'
      pattern: 'loading="lazy"'
---

<objective>
Implement image optimization to dramatically reduce page load times and improve mobile experience.

Purpose: Large unoptimized images (2-5MB from cameras) destroy mobile UX and hurt SEO. WebP reduces file size by 30-50% vs JPEG. Lazy loading prevents downloading 20 product images on catalog page load. Thumbnails prevent serving 4000x3000px images when displaying 200x200px.

Output: Automatic image optimization system that generates WebP/JPEG thumbnails on-the-fly, caches them, and serves via native lazy loading. Zero manual intervention required.
</objective>

<execution_context>
@C:\Users\user\Desktop\mi_tech\.planning\workflows\execute-plan.md
@C:\Users\user\Desktop\mi_tech\.planning\templates\summary.md
</execution_context>

<context>
@C:\Users\user\Desktop\mi_tech\.planning\PROJECT.md
@C:\Users\user\Desktop\mi_tech\.planning\ROADMAP.md
@C:\Users\user\Desktop\mi_tech\.planning\STATE.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\04-polish-launch\04-CONTEXT.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\04-polish-launch\04-RESEARCH.md

## Prior Phase Context

Product images stored in storage/app/public/images via Storage::disk('public') (03-01).
Products table has main_image column (path relative to storage/public) (01-01).
ProductImage model has image column for additional images (01-01).
Laravel 12 with Vite for asset compilation (01-01).
Catalog shows product images in grid layout (01-02).
Product detail shows image gallery with multiple images (01-02).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Intervention Image</name>
  <files>
    composer.json
    config/image.php
  </files>
  <action>
Install Intervention Image Laravel package (v3 for Laravel 12):
```bash
composer require intervention/image-laravel
```

Publish configuration:
```bash
php artisan vendor:publish --provider="Intervention\Image\Laravel\ServiceProvider"
```

Update config/image.php:
- Set driver to 'gd' (better compatibility, no extra PHP extensions needed vs imagick)
- Configure default options:
  * quality: 85 for JPEG (balance size/quality)
  * webp_quality: 80 (WebP compresses better, can use lower quality)
  * cache: true (enable automatic caching)
- Keep default intervention disk: 'public'

Why GD driver: Pre-installed with most PHP installations. Imagick requires php-imagick extension (extra setup on shared hosting). GD handles basic resize/format conversion perfectly for e-commerce use case.

Why these quality settings: 85 JPEG is visually lossless for product photos. 80 WebP achieves similar visual quality at smaller file size. Lower values show compression artifacts. Higher values inflate file size with negligible quality gain.
  </action>
  <verify>
```bash
composer show intervention/image-laravel
cat config/image.php | grep -E "(driver|quality)"
```
intervention/image-laravel installed.
config/image.php exists with driver: gd and quality settings.
  </verify>
  <done>
intervention/image-laravel package installed and configured.
GD driver selected for maximum compatibility.
Quality settings optimized for web delivery (85 JPEG, 80 WebP).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ImageService for on-the-fly optimization</name>
  <files>
    app/Services/ImageService.php
  </files>
  <action>
Create ImageService at app/Services/ImageService.php:

Define size constants:
```php
public const SIZES = [
    'thumb' => 200,   // Catalog listing
    'medium' => 600,  // Product detail main image
    'large' => 1200,  // Product gallery zoom
];
```

Method: getOptimizedImage(string $originalPath, string $size = 'medium'): array
- Input: $originalPath relative to storage/public (e.g., "images/products/abc.jpg")
- Input: $size one of 'thumb', 'medium', 'large'
- Return: ['webp' => path, 'jpeg' => path] relative to storage/public
- Logic:
  * Get width from SIZES constant
  * Generate cache key: "img_{$size}_" . md5($originalPath)
  * Cache::remember($cacheKey, now()->addMonth(), function())
  * Inside cache function:
    - Call generateWebP($originalPath, $width) -> returns path
    - Call generateJpeg($originalPath, $width) -> returns path
    - Return array of both paths

Private method: generateWebP(string $path, int $width): string
- Output path: "images/thumbnails/{$width}/" . basename($path, '.jpg') . '.webp'
- Check if Storage::disk('public')->exists($outputPath), return if exists
- Otherwise:
  * Image::read(Storage::disk('public')->path($path))
  * $image->scale(width: $width) (maintains aspect ratio)
  * $image->toWebp(quality: 80)
  * Storage::disk('public')->put($outputPath, (string) $image)
- Return $outputPath

Private method: generateJpeg(string $path, int $width): string
- Output path: "images/thumbnails/{$width}/" . basename($path)
- Check if exists, return if exists
- Otherwise:
  * Image::read(Storage::disk('public')->path($path))
  * $image->scale(width: $width)
  * $image->toJpeg(quality: 85)
  * Storage::disk('public')->put($outputPath, (string) $image)
- Return $outputPath

Import: use Intervention\Image\Laravel\Facades\Image, use Illuminate\Support\Facades\Storage, use Illuminate\Support\Facades\Cache

Why on-the-fly generation: Admin uploads original once. Thumbnails generated only when needed. Adding new size (e.g., 'xlarge' => 1920) doesn't require regenerating existing images. Storage efficient - originals preserved, thumbnails created on demand.

Why cache for 1 month: Generated images rarely change (only if product image replaced). Long cache TTL reduces repeated generation. Cache key includes original path - if image changes, new cache key generated automatically.
  </action>
  <verify>
```bash
cat app/Services/ImageService.php | grep -E "(class ImageService|SIZES|getOptimizedImage|generateWebP|generateJpeg)"
```
ImageService exists with size constants and three methods.
Uses Intervention Image and Laravel Cache.
  </verify>
  <done>
ImageService created with on-the-fly thumbnail generation.
Supports three sizes: thumb (200px), medium (600px), large (1200px).
Generates both WebP and JPEG versions for browser compatibility.
Results cached for 1 month to prevent repeated generation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Blade component for optimized images</name>
  <files>
    app/View/Components/ProductImage.php
    resources/views/components/product-image.blade.php
  </files>
  <action>
Create Blade component class app/View/Components/ProductImage.php:
```php
namespace App\View\Components;
use Illuminate\View\Component;
use App\Services\ImageService;

class ProductImage extends Component
{
    public string $image;
    public string $alt;
    public string $size;
    public array $paths;

    public function __construct(string $image, string $alt, string $size = 'medium')
    {
        $this->image = $image;
        $this->alt = $alt;
        $this->size = $size;

        $imageService = app(ImageService::class);
        $this->paths = $imageService->getOptimizedImage($image, $size);
    }

    public function render()
    {
        return view('components.product-image');
    }
}
```

Create Blade template resources/views/components/product-image.blade.php:
```blade
<picture {{ $attributes->merge(['class' => 'block']) }}>
    <source type="image/webp" srcset="{{ asset('storage/' . $paths['webp']) }}">
    <source type="image/jpeg" srcset="{{ asset('storage/' . $paths['jpeg']) }}">
    <img
        src="{{ asset('storage/' . $paths['jpeg']) }}"
        alt="{{ $alt }}"
        loading="lazy"
        {{ $attributes->merge(['class' => 'w-full h-auto object-cover']) }}
    >
</picture>
```

Why <picture> element: Browser automatically selects best format. Modern browsers choose WebP (smaller), older browsers fallback to JPEG. Single source of truth - no JavaScript required.

Why loading="lazy" by default: 95%+ browser support (2026). Browsers natively defer loading images below the fold until user scrolls near. Reduces initial page weight dramatically (catalog page with 20 products only loads visible 4-6 images initially).

Why merge attributes: Allows consumer to add classes, data attributes, etc: <x-product-image :image="..." :alt="..." class="rounded-lg shadow" />. Tailwind classes passed through while maintaining defaults.
  </action>
  <verify>
```bash
cat app/View/Components/ProductImage.php | grep -E "(class ProductImage|ImageService|getOptimizedImage)"
cat resources/views/components/product-image.blade.php | grep -E "(<picture>|<source type=|loading=)"
```
ProductImage component calls ImageService in constructor.
Blade template uses <picture> with WebP/JPEG sources and lazy loading.
  </verify>
  <done>
ProductImage Blade component created with ImageService integration.
Component generates <picture> element with WebP and JPEG sources.
Native lazy loading attribute applied to all images.
Attributes can be passed through for styling flexibility.
  </done>
</task>

<task type="auto">
  <name>Task 4: Replace image tags in views with optimized component</name>
  <files>
    resources/views/products/index.blade.php
    resources/views/products/show.blade.php
    resources/views/home.blade.php
  </files>
  <action>
Update product catalog (resources/views/products/index.blade.php):
- Find existing <img> tags rendering product images (likely in @foreach loop over products)
- Replace with: <x-product-image :image="$product->main_image" :alt="$product->name" size="thumb" class="..." />
- Keep existing Tailwind classes (rounded, shadow, etc.) but move to component call
- Preserve existing grid layout and product card structure

Update product detail (resources/views/products/show.blade.php):
- Main product image: Replace with <x-product-image :image="$product->main_image" :alt="$product->name" size="medium" />
- Image gallery (if exists): Replace with size="large" for zoomable images
- If multiple images in gallery: Loop over $product->images, use <x-product-image :image="$image->image" :alt="$product->name" size="large" />

Update homepage (resources/views/home.blade.php):
- Find featured/popular products section (likely showing product grid)
- Replace product image tags with <x-product-image :image="$product->main_image" :alt="$product->name" size="thumb" />
- Keep existing styling and layout

Don't change:
- Admin panel image uploads (admin views should show originals for preview)
- Any decorative images (logos, icons, banners) - only product images need optimization

Ensure:
- No direct <img> tags remain for product images (grep to verify)
- All product listings use size="thumb" (200px)
- All product detail main images use size="medium" (600px)
- Gallery/zoom images use size="large" (1200px)

Why different sizes per context: Catalog needs small thumbnails (fast loading, many images). Product detail needs medium quality (main focus, single image). Gallery needs large for zoom (optional, user-initiated).
  </action>
  <verify>
```bash
grep -n "<x-product-image" resources/views/products/index.blade.php resources/views/products/show.blade.php resources/views/home.blade.php
grep "<img.*product" resources/views/products/*.blade.php || echo "No direct img tags for products"
```
All three views use <x-product-image component.
No direct <img> tags with product images remain.
Catalog uses size="thumb", detail uses size="medium".
  </verify>
  <done>
All product image rendering replaced with ProductImage component.
Catalog page loads 200px thumbnails instead of full-size images.
Product detail page loads 600px medium images for main display.
Native lazy loading active on all product images site-wide.
WebP images served to modern browsers, JPEG fallback for older browsers.
  </done>
</task>

</tasks>

<verification>
1. Run `php artisan serve`, visit catalog page: Network tab shows WebP images loading lazily
2. Scroll down catalog: Images download as they approach viewport (lazy loading working)
3. Visit product detail page: View source shows <picture> with WebP/JPEG sources
4. Check file sizes: WebP images 30-50% smaller than JPEG equivalents in storage/images/thumbnails/
5. Test in Safari: Falls back to JPEG if WebP not supported
6. Check PageSpeed Insights: Score improvement in "Serve images in next-gen formats" and "Properly size images"
</verification>

<success_criteria>
- Product images load in WebP format with JPEG fallback via <picture> element
- Images below the fold don't download until user scrolls (lazy loading verified in Network tab)
- Catalog displays 200px thumbnails, detail shows 600px images (not 4000px originals)
- First request generates thumbnails, subsequent requests serve from cache (fast)
- storage/images/thumbnails/ directory contains generated WebP and JPEG files organized by size
- No performance degradation from on-the-fly generation (cache hit rate >90% after warmup)
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-launch/04-02-SUMMARY.md`
</output>

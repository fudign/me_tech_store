---
phase: 04.2-testing-production
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "WebP images load correctly in Chrome, Firefox, Safari"
    - "Database error page shows user-friendly message when MySQL stopped"
    - "Lazy loading activates on scroll (visible in Network tab)"
    - "HTTPS configured and working on production server"
    - "Settings changes in admin panel appear on storefront"
  artifacts:
    - path: "resources/views/components/product-image.blade.php"
      provides: "WebP/JPEG picture element with lazy loading"
      exists: true
    - path: "resources/views/errors/database-unavailable.blade.php"
      provides: "User-friendly database error page"
      exists: true
    - path: "bootstrap/app.php"
      provides: "PDOException/QueryException rendering"
      exists: true
    - path: "DEPLOYMENT.md"
      provides: "Production deployment checklist"
      exists: true
  key_links:
    - from: "product-image.blade.php"
      to: "browser WebP support"
      via: "<picture> element automatic format selection"
      pattern: "<source.*webp.*<img"
    - from: "bootstrap/app.php"
      to: "database-unavailable.blade.php"
      via: "PDOException catch and render"
      pattern: "PDOException.*database-unavailable"
    - from: "admin settings form"
      to: "storefront layout"
      via: "Setting::get() with cache"
      pattern: "Setting::get"
---

<objective>
Close Phase 4 gaps through browser testing and production deployment verification. Confirm image optimization (WebP, lazy loading), database error handling (ERR-02), and HTTPS configuration (SEC-06) all work correctly in real-world conditions.

Purpose: Validate Phase 4 implementations in browser and production environment before milestone sign-off
Output: Verified Phase 4 features with evidence, production deployment complete with HTTPS
</objective>

<execution_context>
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\user\Desktop\mi_tech\.planning\PROJECT.md
@C:\Users\user\Desktop\mi_tech\.planning\ROADMAP.md
@C:\Users\user\Desktop\mi_tech\.planning\STATE.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\04-polish-launch\04-VERIFICATION.md
@C:\Users\user\Desktop\mi_tech\DEPLOYMENT.md

**Gap Closure Context:**

This plan addresses three open gaps from 04-VERIFICATION.md:

**Gap #3: Image Optimization Browser Testing**
- Status: Code complete in 04-02, needs browser verification
- WebP serving via `<picture>` element not tested in real browsers
- Lazy loading (loading="lazy" attribute) not verified in Network tab
- Evidence needed: Screenshots showing WebP format and deferred loading

**Gap #4: Database Error Page Verification**
- Status: Code complete in 04-03, needs functional testing
- ERR-02 implementation in bootstrap/app.php not tested
- Database unavailable page not seen in browser
- Evidence needed: Stop MySQL, verify friendly 503 page displays

**Gap #5: Production HTTPS (SEC-06)**
- Status: DEPLOYMENT.md created in 04-03, not deployed
- HTTPS configuration required for production readiness
- Let's Encrypt certificate installation and verification
- Evidence needed: Production site loads over HTTPS

**Implementation already complete:**
- Image optimization: resources/views/components/product-image.blade.php
- Database error handling: bootstrap/app.php, resources/views/errors/database-unavailable.blade.php
- Settings integration: resources/views/layouts/app.blade.php (fixed in 04.1-01)

This phase is verification-only - no code changes expected.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start local development server for browser testing</name>
  <files>None (testing only)</files>
  <action>
Start Laravel development server and prepare browser testing environment.

1. Ensure database is running and seeded:
   - `php artisan migrate:fresh --seed` (if needed for clean state)
   - Verify products exist with images

2. Clear all caches for accurate testing:
   - `php artisan cache:clear`
   - `php artisan view:clear`
   - `php artisan config:clear`

3. Start development server:
   - `php artisan serve`
   - Note the URL (typically http://127.0.0.1:8000)

4. Verify server responds:
   - `curl http://127.0.0.1:8000` returns homepage HTML
   - No errors in terminal output

This prepares clean environment for manual browser testing in next tasks.
  </action>
  <verify>
`php artisan serve` running without errors, homepage accessible at http://127.0.0.1:8000
  </verify>
  <done>
Development server running, database populated with products that have images, all caches cleared
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Image optimization system with WebP conversion and lazy loading (completed in Phase 04-02)

Code implements:
- WebP image generation via ImageService.php
- Picture element with WebP source + JPEG fallback in product-image.blade.php
- Native lazy loading via loading="lazy" attribute
- Three size tiers: 200px (thumb), 600px (medium), 1200px (large)
  </what-built>

  <how-to-verify>
**Test 1: WebP Format Serving**

1. Open Chrome browser
2. Navigate to http://127.0.0.1:8000
3. Click on any product to view product detail page
4. Open DevTools (F12) → Network tab
5. Reload page (Ctrl+R)
6. Filter by "Img" type
7. Click on product image request
8. Check "Type" column - should show "webp"
9. Verify: Product images load as WebP format in Chrome

10. Repeat steps 1-7 in Firefox (if available)
11. Repeat steps 1-7 in Safari (if available, or skip if Windows)

Expected: Chrome and Firefox load WebP, Safari may load JPEG (fallback)

**Test 2: Lazy Loading Activation**

1. Open Chrome browser with DevTools (F12) → Network tab
2. Navigate to http://127.0.0.1:8000 (homepage with product grid)
3. Clear Network log (trash icon)
4. Scroll down slowly through product grid
5. Watch Network tab - new image requests should appear ONLY as you scroll
6. Images below the fold should NOT load until scrolled into view
7. Verify: Image requests appear progressively during scroll (not all at once)

**Test 3: Picture Element Structure**

1. Navigate to product detail page
2. Right-click product image → Inspect Element
3. Verify HTML structure:
   ```html
   <picture>
     <source srcset="...webp" type="image/webp">
     <img src="...jpg" loading="lazy">
   </picture>
   ```
4. Confirm: WebP source before JPEG img, loading="lazy" present

**Evidence Collection:**

Document findings:
- Browser: Chrome/Firefox/Safari
- WebP loaded: Yes/No (from Network tab Type column)
- Lazy loading worked: Yes/No (images loaded progressively during scroll)
- Any issues observed: (describe if images don't load, wrong format, etc.)
  </how-to-verify>

  <resume-signal>
Type "approved" if WebP loads in Chrome/Firefox and lazy loading activates on scroll.

Or describe any issues found (e.g., "WebP not loading", "all images load immediately").
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Database error handling system with user-friendly 503 page (completed in Phase 04-03, ERR-02 requirement)

Code implements:
- PDOException and QueryException catching in bootstrap/app.php
- 503 status code (Service Temporarily Unavailable)
- User-friendly Russian error page: database-unavailable.blade.php
- Error logging with URL and IP (no stack trace exposure)
  </what-built>

  <how-to-verify>
**Test 1: Database Error Page Display**

IMPORTANT: This test requires stopping MySQL temporarily. Ensure you can restart it.

1. Verify site works normally first:
   - Visit http://127.0.0.1:8000
   - Should load homepage successfully

2. Stop MySQL service:
   - **Windows:** Open Services (services.msc), find MySQL, click Stop
   - **Linux/Mac:** `sudo systemctl stop mysql` or `brew services stop mysql`

3. Test error page:
   - Visit http://127.0.0.1:8000 (or refresh)
   - Should see Russian error page: "Сервис временно недоступен"
   - Page should use storefront layout (header, footer visible)
   - Should NOT see Laravel stack trace or exception details

4. Check HTTP status code:
   - Open DevTools (F12) → Network tab
   - Reload page
   - Click on document request (first item)
   - Status should be "503 Service Unavailable" (not 500)

5. Restart MySQL service:
   - **Windows:** Services → MySQL → Start
   - **Linux/Mac:** `sudo systemctl start mysql` or `brew services start mysql`

6. Verify recovery:
   - Visit http://127.0.0.1:8000
   - Site should work normally again

**Test 2: Error Logging**

1. After stopping MySQL (step 2 above), check Laravel log:
   - Open: storage/logs/laravel.log
   - Look for recent PDOException entry
   - Should contain: URL, IP address, error message
   - Should NOT contain full stack trace in production mode

**Evidence Collection:**

Document findings:
- Error page displayed: Yes/No
- HTTP status code: 503/500/other
- Page shows friendly message (not stack trace): Yes/No
- Site recovered after MySQL restart: Yes/No
- Error logged in laravel.log: Yes/No
  </how-to-verify>

  <resume-signal>
Type "approved" if error page shows friendly message with 503 status, and site recovers after MySQL restart.

Or describe any issues (e.g., "shows stack trace", "500 status", "site doesn't recover").
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Settings integration connecting admin panel to storefront display (completed in Phase 04.1-01)

Code implements:
- Setting::get() calls in resources/views/layouts/app.blade.php
- Six Setting::get() calls with fallback values: phone, address, email, footer_text
- 24-hour cache with automatic invalidation on Setting::set()
- Admin settings form at /admin/settings
  </what-built>

  <how-to-verify>
**Test: Admin Settings → Storefront Display Flow**

1. View current storefront values:
   - Visit http://127.0.0.1:8000
   - Note phone number in top header bar
   - Scroll to footer, note address, email, footer text

2. Change settings in admin panel:
   - Visit http://127.0.0.1:8000/admin (login if needed)
   - Click "Settings" in sidebar
   - Change phone number (e.g., add digit or change last digit)
   - Change address (e.g., add "TEST" to end)
   - Click Save

3. Clear cache (settings have 24h TTL):
   - Run: `php artisan cache:clear`

4. Verify changes appear on storefront:
   - Visit http://127.0.0.1:8000 (refresh if already open)
   - Check top header bar: phone should show NEW value
   - Scroll to footer: address should show NEW value
   - Confirm: Admin changes propagated to storefront

5. Test fallback values (optional, advanced):
   - Clear a setting value in admin (leave field empty)
   - Save, clear cache, refresh storefront
   - Should show default fallback (not blank or error)

**Evidence Collection:**

Document findings:
- Settings form accessible in admin: Yes/No
- Phone change appeared on storefront: Yes/No
- Address change appeared on storefront: Yes/No
- Footer text displays correctly: Yes/No
- Any errors or blank fields: (describe)
  </how-to-verify>

  <resume-signal>
Type "approved" if admin setting changes appear on storefront after cache clear.

Or describe issues (e.g., "changes don't appear", "shows blank values", "admin form error").
  </resume-signal>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>Production Deployment Approach</decision>

  <context>
Phase 4.2 requires HTTPS deployment to production server (SEC-06 requirement). This involves server configuration, SSL certificates, and domain setup.

The codebase is production-ready:
- DEPLOYMENT.md provides comprehensive checklist
- .env.production template exists
- All optimizations implemented (caching, indexes, image optimization)
- Error handling tested in local environment

However, production deployment requires access to:
- Production server (VPS/shared hosting)
- Domain name and DNS configuration
- SSH access for server commands
- Let's Encrypt for SSL certificate

Gap closure can be completed in two ways:
  </context>

  <options>
    <option id="deploy-now">
      <name>Deploy to Production Now</name>
      <pros>
- Fully closes SEC-06 requirement gap
- Provides real-world HTTPS verification
- Completes Phase 4.2 with production evidence
- Site goes live (if ready for public)
      </pros>
      <cons>
- Requires production server access and credentials
- Takes additional time (server setup, DNS, SSL)
- May reveal unexpected production issues
- Commits to live deployment timeline
      </cons>
      <requirements>
- VPS/hosting account with SSH access
- Domain name pointed to server IP
- Root/sudo access for SSL certificate installation
- 1-2 hours for full deployment and verification
      </requirements>
    </option>

    <option id="deploy-staging">
      <name>Deploy to Staging Environment</name>
      <pros>
- Tests full deployment process without going live
- Can verify HTTPS with self-signed cert or Let's Encrypt
- Identifies production issues before real launch
- Lower risk, can iterate
      </pros>
      <cons>
- Still requires staging server access
- Doesn't fully close SEC-06 (production requirement)
- Adds extra step before final production deploy
      </cons>
      <requirements>
- Staging server with SSH access
- Subdomain for staging (e.g., staging.domain.com)
- Time for deployment and testing
      </requirements>
    </option>

    <option id="verify-checklist">
      <name>Verify DEPLOYMENT.md Completeness Only</name>
      <pros>
- No server access needed immediately
- Validates deployment documentation is comprehensive
- Allows deployment at user's chosen timeline
- Closes Phase 4.2 with checklist verification
      </pros>
      <cons>
- Doesn't actually verify HTTPS works in production
- SEC-06 remains technically open until deployed
- Less confidence in production readiness
      </cons>
      <requirements>
- Review DEPLOYMENT.md for completeness
- Confirm all production environment steps documented
- No server access required
      </requirements>
    </option>

    <option id="defer-deployment">
      <name>Defer Production Deployment to User</name>
      <pros>
- User controls deployment timeline
- User may have existing deployment workflow
- Phase 4 verification complete except SEC-06
- All code ready, only deployment step remains
      </pros>
      <cons>
- SEC-06 remains open (HTTPS not verified)
- User must handle deployment independently
- No automated verification of production setup
      </cons>
      <requirements>
- Document SEC-06 as remaining manual step
- Provide DEPLOYMENT.md as guide
- User deploys when ready
      </requirements>
    </option>
  </options>

  <resume-signal>
Select one of:
- **deploy-now** - Deploy to production server with HTTPS now
- **deploy-staging** - Deploy to staging environment first
- **verify-checklist** - Review DEPLOYMENT.md completeness, defer actual deployment
- **defer-deployment** - Mark deployment as user's manual task, close Phase 4.2

Or provide custom instructions (e.g., "deploy to specific hosting provider", "use existing server at IP x.x.x.x").
  </resume-signal>
</task>

</tasks>

<verification>
**Gap Closure Verification:**

After completing all tasks, verify gaps closed:

1. **Gap #3 (Image Optimization Browser Testing):**
   - [ ] WebP images load in Chrome/Firefox (Network tab shows "webp" type)
   - [ ] Lazy loading activates on scroll (Network tab shows progressive loading)
   - [ ] Picture element has correct structure (WebP source + JPEG fallback)
   - Evidence: Browser testing checkpoint approved

2. **Gap #4 (Database Error Page Verification):**
   - [ ] Stopping MySQL shows friendly 503 page (not stack trace)
   - [ ] Page uses storefront layout (header/footer visible)
   - [ ] Site recovers after MySQL restart
   - [ ] Error logged in storage/logs/laravel.log
   - Evidence: Database error checkpoint approved

3. **Gap #5 (Production HTTPS - SEC-06):**
   - [ ] Deployment approach decided
   - [ ] HTTPS configuration verified OR deployment plan documented
   - Evidence: Decision checkpoint completed

**Additional Verification:**

4. **Settings Integration (from 04.1-01):**
   - [ ] Admin settings changes appear on storefront after cache clear
   - [ ] Phone, address, email, footer_text all display correctly
   - Evidence: Settings checkpoint approved
</verification>

<success_criteria>
**Phase 4.2 complete when:**

1. WebP images verified loading correctly in browser (Chrome/Firefox tested)
2. Lazy loading verified activating on scroll (Network tab evidence)
3. Database error page verified showing friendly message when MySQL stopped
4. Settings integration verified working (admin changes → storefront display)
5. Production deployment approach decided and documented
6. All checkpoint approvals received with evidence

**Measurable outcomes:**
- Browser DevTools Network tab shows "webp" image type
- Network tab shows progressive image loading during scroll
- Stopping MySQL displays "Сервис временно недоступен" page with 503 status
- Admin settings form changes reflected on storefront after cache clear
- HTTPS deployment plan exists (DEPLOYMENT.md verified or deployment completed)

**Phase 4 fully complete when Phase 4.2 criteria met.**
</success_criteria>

<output>
After completion, create `.planning/phases/04.2-testing-production/04.2-01-SUMMARY.md` documenting:
- Browser testing results (WebP format, lazy loading evidence)
- Database error page testing results (screenshots or description)
- Settings integration verification
- Production deployment decision and next steps
- All gap closures confirmed with evidence
</output>

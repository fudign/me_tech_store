---
phase: 03-admin-panel
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Http/Controllers/Admin/CategoryController.php
  - app/Http/Requests/StoreCategoryRequest.php
  - app/Http/Requests/UpdateCategoryRequest.php
  - app/Models/Setting.php
  - app/Http/Controllers/Admin/SettingsController.php
  - resources/views/admin/categories/index.blade.php
  - resources/views/admin/categories/create.blade.php
  - resources/views/admin/categories/edit.blade.php
  - resources/views/admin/settings/index.blade.php
  - database/migrations/2026_01_23_create_settings_table.php
  - routes/web.php
autonomous: true

must_haves:
  truths:
    - "Administrator can view list of all categories"
    - "Administrator can create new category with name and description"
    - "Administrator can edit existing category"
    - "Administrator can delete category (if no products assigned)"
    - "Administrator can change site phone, address, email, footer text"
    - "Settings persist across sessions and page loads"
    - "Category slug auto-generates from name"
  artifacts:
    - path: "app/Http/Controllers/Admin/CategoryController.php"
      provides: "Category CRUD operations"
      exports: ["index", "create", "store", "edit", "update", "destroy"]
    - path: "app/Models/Setting.php"
      provides: "Key-value settings storage"
      exports: ["get", "set"]
      min_lines: 20
    - path: "app/Http/Controllers/Admin/SettingsController.php"
      provides: "Settings page and update"
      exports: ["index", "update"]
    - path: "resources/views/admin/settings/index.blade.php"
      provides: "Settings form with 4 fields"
      min_lines: 50
  key_links:
    - from: "resources/views/admin/categories/index.blade.php"
      to: "route('admin.categories.destroy')"
      via: "delete confirmation modal"
      pattern: "showModal.*deleteUrl"
    - from: "app/Http/Controllers/Admin/SettingsController.php"
      to: "Setting::set()"
      via: "save settings"
      pattern: "Setting::set"
    - from: "resources/views/admin/settings/index.blade.php"
      to: "Setting::get()"
      via: "load settings"
      pattern: "Setting::get"
---

<objective>
Implement category management CRUD and site-wide settings editor for admin panel.

Purpose: Enable administrator to organize products into categories and control site-wide information (phone, address, email, footer) displayed on storefront.

Output: Working category CRUD with list/create/edit/delete and settings page with form to update 4 key site values.
</objective>

<execution_context>
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\user\Desktop\mi_tech\.planning\PROJECT.md
@C:\Users\user\Desktop\mi_tech\.planning\ROADMAP.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\03-admin-panel\03-CONTEXT.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\03-admin-panel\03-RESEARCH.md

## Existing Patterns
@C:\Users\user\Desktop\mi_tech\app\Models\Category.php
@C:\Users\user\Desktop\mi_tech\app\Http\Controllers\Admin\OrderController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Category Controller and CRUD Views</name>
  <files>
    app/Http/Controllers/Admin/CategoryController.php
    app/Http/Requests/StoreCategoryRequest.php
    app/Http/Requests/UpdateCategoryRequest.php
    resources/views/admin/categories/index.blade.php
    resources/views/admin/categories/create.blade.php
    resources/views/admin/categories/edit.blade.php
    routes/web.php
  </files>
  <action>
Create Category CRUD following same pattern as ProductController but simpler (no images, no attributes):

**CategoryController methods:**
- index(): List categories with products count, pagination 20
- create(): Show create form
- store(StoreCategoryRequest): Create category
- edit(Category): Show edit form
- update(UpdateCategoryRequest): Update category
- destroy(Category): Delete if no products attached, else return error

**StoreCategoryRequest validation:**
- name: required|max:200
- description: nullable|string
- slug: nullable|max:200|unique:categories
- is_active: nullable|boolean
- meta_title: nullable|max:200
- meta_description: nullable|max:300

**UpdateCategoryRequest validation:**
Same as Store except slug: nullable|max:200|unique:categories,slug,{id}

**Destroy logic:**
```php
if ($category->products()->count() > 0) {
  return back()->with('error', 'Невозможно удалить категорию с товарами');
}
$category->delete();
return redirect()->route('admin.categories.index')
  ->with('success', 'Категория удалена');
```

**Routes (add to admin group):**
```php
Route::resource('categories', CategoryController::class);
```

**index.blade.php:**
Same structure as products list but simpler:
- Columns: Name | Slug | Products Count | Status | Actions
- Products Count: $category->products()->count() (eager load withCount('products'))
- Delete confirmation modal (Alpine.js pattern)
- No images to display

**create.blade.php and edit.blade.php:**
Simple forms (not tabbed, categories are simpler than products):
- Name (required)
- Slug (auto-generated, editable)
- Description (textarea)
- Status checkbox (is_active)
- Meta Title
- Meta Description

Forms extend admin.layouts.app, same styling as product forms.
Include validation error display.
Save/Cancel buttons at bottom.

Use Spatie Sluggable (already on Category model) for auto slug generation.
Follow Phase 2 admin styling patterns.
</action>
  <verify>
```bash
php artisan route:list --path=admin/categories
grep -n "class CategoryController" app/Http/Controllers/Admin/CategoryController.php
grep -n "products()->count()" app/Http/Controllers/Admin/CategoryController.php
ls resources/views/admin/categories/
```
  </verify>
  <done>
CategoryController exists with 6 CRUD methods
Category forms (create, edit) exist and extend admin layout
Category list shows product count per category
Delete validation prevents removing category with products
Routes registered
StoreCategoryRequest and UpdateCategoryRequest exist
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Settings Model and Management Interface</name>
  <files>
    app/Models/Setting.php
    database/migrations/2026_01_23_create_settings_table.php
    app/Http/Controllers/Admin/SettingsController.php
    resources/views/admin/settings/index.blade.php
    routes/web.php
  </files>
  <action>
Implement simple key-value settings system per RESEARCH pattern:

**Migration: create_settings_table**
```php
Schema::create('settings', function (Blueprint $table) {
    $table->id();
    $table->string('key')->unique();
    $table->text('value')->nullable();
    $table->timestamps();
});
```

**Setting model (app/Models/Setting.php):**
```php
class Setting extends Model
{
    protected $fillable = ['key', 'value'];

    public static function get(string $key, $default = null)
    {
        $setting = static::where('key', $key)->first();
        return $setting ? $setting->value : $default;
    }

    public static function set(string $key, $value): void
    {
        static::updateOrCreate(
            ['key' => $key],
            ['value' => $value]
        );
    }
}
```

**SettingsController:**
Two methods only:
- index(): Load 4 settings and pass to view
  ```php
  $settings = [
    'phone' => Setting::get('site.phone', ''),
    'address' => Setting::get('site.address', ''),
    'email' => Setting::get('site.email', ''),
    'footer_text' => Setting::get('site.footer_text', ''),
  ];
  return view('admin.settings.index', compact('settings'));
  ```

- update(Request): Validate and save all 4 settings
  ```php
  $request->validate([
    'phone' => 'required|string|max:20',
    'address' => 'required|string|max:255',
    'email' => 'required|email|max:100',
    'footer_text' => 'nullable|string|max:500',
  ]);

  Setting::set('site.phone', $request->phone);
  Setting::set('site.address', $request->address);
  Setting::set('site.email', $request->email);
  Setting::set('site.footer_text', $request->footer_text);

  return back()->with('success', 'Настройки сохранены');
  ```

**Routes (add to admin group):**
```php
Route::get('settings', [SettingsController::class, 'index'])->name('settings.index');
Route::post('settings', [SettingsController::class, 'update'])->name('settings.update');
```

**settings/index.blade.php:**
Single-page form extending admin.layouts.app:
- Title "Настройки сайта"
- Success message banner if flash session
- Form with 4 fields:
  1. Телефон (phone): text input with placeholder "+996 XXX XXX XXX"
  2. Адрес (address): text input
  3. Email: email input
  4. Текст в footer (footer_text): textarea, 3 rows
- Save button at bottom (blue primary)
- No Cancel button (settings always stay on same page)

Form submits to route('admin.settings.update') POST with @csrf.

Use same Tailwind styling as other admin forms.
No tabs needed (only 4 simple fields per CONTEXT).
</action>
  <verify>
```bash
php artisan migrate --pretend | grep settings
grep -n "class Setting" app/Models/Setting.php
grep -n "public static function get" app/Models/Setting.php
grep -n "class SettingsController" app/Http/Controllers/Admin/SettingsController.php
php artisan route:list --path=admin/settings
```
  </verify>
  <done>
Settings table migration created and ready to run
Setting model exists with static get() and set() helpers
SettingsController exists with index and update methods
Settings form exists with 4 fields
Routes registered for settings
Validation ensures required fields filled
updateOrCreate prevents duplicate key entries
  </done>
</task>

</tasks>

<verification>
**Run migration:**
```bash
php artisan migrate
```

**Seed test category:**
```bash
php artisan tinker
>>> App\Models\Category::create(['name' => 'Test Category', 'is_active' => true])
```

**Manual browser testing:**
1. Visit /admin/categories - see category list with product counts
2. Create new category - form works, slug auto-generates
3. Edit category - pre-filled correctly
4. Try to delete category with products - error message appears
5. Delete category without products - succeeds
6. Visit /admin/settings - form displays
7. Fill all 4 fields, save - success message appears
8. Refresh page - settings persist (loaded from database)
9. Check storefront footer/contact displays settings values

**Database verification:**
```bash
php artisan tinker
>>> App\Models\Setting::get('site.phone')
>>> App\Models\Setting::all()
```
</verification>

<success_criteria>
- Admin can view all categories with product counts
- Admin can create new category with auto slug generation
- Admin can edit existing categories
- Admin cannot delete category with assigned products (validation message shown)
- Admin can delete empty categories
- Admin can update site phone, address, email, footer text
- Settings persist in database across sessions
- Settings display correctly in admin form
- Category CRUD follows same patterns as Product CRUD for consistency
- All forms have validation and flash messages
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-panel/03-02-SUMMARY.md` using summary template.

Document:
- Setting model implementation (static helpers approach)
- Category validation (prevent delete with products)
- Settings keys used (site.phone, site.address, site.email, site.footer_text)
- Any deviations from plan
</output>

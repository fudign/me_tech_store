---
phase: 03-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Http/Controllers/Admin/ProductController.php
  - app/Http/Requests/StoreProductRequest.php
  - app/Http/Requests/UpdateProductRequest.php
  - resources/views/admin/products/index.blade.php
  - resources/views/admin/products/create.blade.php
  - resources/views/admin/products/edit.blade.php
  - routes/web.php
autonomous: true

must_haves:
  truths:
    - "Administrator can view list of all products with pagination"
    - "Administrator can create new product with name, price, description"
    - "Administrator can upload multiple images for product"
    - "Administrator can select which image is main image"
    - "Administrator can add dynamic attributes (key-value pairs like Память: 256GB)"
    - "Administrator can edit existing product and update all fields"
    - "Administrator can delete product with confirmation"
    - "Product slug generates automatically from name but can be manually edited"
  artifacts:
    - path: "app/Http/Controllers/Admin/ProductController.php"
      provides: "Product CRUD operations with image handling"
      exports: ["index", "create", "store", "edit", "update", "destroy"]
    - path: "app/Http/Requests/StoreProductRequest.php"
      provides: "Product creation validation rules"
      min_lines: 40
    - path: "app/Http/Requests/UpdateProductRequest.php"
      provides: "Product update validation rules"
      min_lines: 40
    - path: "resources/views/admin/products/index.blade.php"
      provides: "Product list with search and pagination"
      min_lines: 60
    - path: "resources/views/admin/products/create.blade.php"
      provides: "4-tab product creation form"
      min_lines: 150
  key_links:
    - from: "resources/views/admin/products/create.blade.php"
      to: "route('admin.products.store')"
      via: "form submission"
      pattern: "action=.*admin\\.products\\.store"
    - from: "app/Http/Controllers/Admin/ProductController.php"
      to: "Storage::disk('public')"
      via: "image upload handling"
      pattern: "Storage::disk\\('public'\\)"
    - from: "resources/views/admin/products/create.blade.php"
      to: "Alpine.js attributeManager"
      via: "dynamic attribute fields"
      pattern: "x-data.*attributeManager"
---

<objective>
Build complete product management CRUD for admin panel with multi-image upload, dynamic attributes, tabbed form interface, and confirmation modals.

Purpose: Enable administrator to fully manage product catalog including images, specifications, pricing, and SEO metadata through intuitive 4-tab form interface.

Output: Working product CRUD with list view, create/edit forms with image management, attribute handling, and validation.
</objective>

<execution_context>
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\user\Desktop\mi_tech\.planning\PROJECT.md
@C:\Users\user\Desktop\mi_tech\.planning\ROADMAP.md
@C:\Users\user\Desktop\mi_tech\.planning\STATE.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\03-admin-panel\03-CONTEXT.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\03-admin-panel\03-RESEARCH.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-03-SUMMARY.md

## Existing Models & Patterns
@C:\Users\user\Desktop\mi_tech\app\Models\Product.php
@C:\Users\user\Desktop\mi_tech\app\Models\Category.php
@C:\Users\user\Desktop\mi_tech\app\Http\Controllers\Admin\OrderController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Product Controller and Form Requests</name>
  <files>
    app/Http/Controllers/Admin/ProductController.php
    app/Http/Requests/StoreProductRequest.php
    app/Http/Requests/UpdateProductRequest.php
    routes/web.php
  </files>
  <action>
Create Admin\ProductController with full CRUD operations following Phase 2 OrderController pattern:

**Controller methods:**
- index(): List products with eager loading (categories, attributes), pagination 20
- create(): Load active categories for form
- store(StoreProductRequest): Handle image uploads to storage/app/public/products, save product with attributes
- edit(Product): Load product with relationships
- update(UpdateProductRequest, Product): Update product, handle new images, sync attributes
- destroy(Product): Delete product and associated images from storage

**Image handling pattern:**
- Use Storage::disk('public')->put() for uploads (auto-generates safe filenames)
- Store array of image paths in products.images JSON field
- Store main_image path separately in products.main_image
- On delete: loop through images array and Storage::delete() each file
- On update with new images: delete old images first, then store new ones

**Attributes handling:**
- attributes sent as array: [{key: 'Память', value: '256GB'}, ...]
- Delete existing attributes: $product->attributes()->delete()
- Create new ones: foreach loop with $product->attributes()->create()

**StoreProductRequest validation:**
- name: required|max:200
- description: nullable|string
- price: required|integer|min:0 (stored in cents)
- old_price: nullable|integer|min:0
- slug: nullable|max:200|unique:products (Spatie Sluggable handles auto-generation if empty)
- categories: nullable|array, categories.*: exists:categories,id
- images: nullable|array|max:10
- images.*: image|mimes:jpg,jpeg,png,webp|max:2048
- main_image_index: nullable|integer|min:0
- attributes: nullable|array
- attributes.*.key: required_with:attributes|string|max:100
- attributes.*.value: required_with:attributes|string|max:255
- is_active: nullable|boolean
- meta_title: nullable|max:200
- meta_description: nullable|max:300

**UpdateProductRequest validation:**
Same as StoreProductRequest except:
- slug: nullable|max:200|unique:products,slug,{id} (ignore current product's slug)

**prepareForValidation in both requests:**
Convert boolean is_active from form checkbox (on/null) to true/false
If price or old_price are in KGS format (divided by 100), multiply by 100 for storage in cents

**Routes (add to existing admin group with auth middleware):**
```php
Route::resource('products', ProductController::class);
```

Use Form Request pattern (not controller validation) per RESEARCH recommendation.
Return with success flash message: ->with('success', 'Товар успешно создан/обновлен/удален')
</action>
  <verify>
Run these commands:
```bash
php artisan route:list --path=admin/products
grep -n "class ProductController" app/Http/Controllers/Admin/ProductController.php
grep -n "class StoreProductRequest" app/Http/Requests/StoreProductRequest.php
```
Verify routes exist: admin.products.index, store, edit, update, destroy
  </verify>
  <done>
ProductController exists with 6 CRUD methods
StoreProductRequest and UpdateProductRequest exist with validation rules
Routes registered in web.php admin group
Image handling uses Storage facade with public disk
Attributes sync pattern established
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Product List View</name>
  <files>resources/views/admin/products/index.blade.php</files>
  <action>
Create admin product list view extending admin.layouts.app (from Phase 2):

**Layout structure:**
```blade
@extends('admin.layouts.app')
@section('title', 'Товары')
@section('content')
```

**Header with Add button:**
- Title "Товары"
- "Добавить товар" button linking to route('admin.products.create')
- Green button with plus icon (Iconify icon="solar:add-circle-linear")

**Success flash message banner:**
If session has 'success', show green banner at top:
- Background bg-green-100, text text-green-800
- Display message, auto-dismiss after 3 seconds (Alpine.js x-init with setTimeout)

**Desktop table (hidden on mobile with md:block):**
Table columns: Image | Name | Price | Categories | Status | Actions
- Image: Display main_image as thumbnail (48x48, object-cover, rounded)
- Name: Product name + slug below in smaller gray text
- Price: Format with number_format($price / 100, 0, ',', ' ') сом, show old_price struck through if exists
- Categories: Display category names joined with comma
- Status: Badge - green "Активен" if is_active, gray "Черновик" if not
- Actions: Edit button (blue), Delete button (red) with Alpine.js modal trigger

**Mobile cards (visible on mobile with md:hidden):**
Card layout for each product with same info stacked vertically

**Pagination:**
{{ $products->links() }} at bottom

**Delete confirmation modal:**
Alpine.js modal pattern from RESEARCH:
- x-data="{ showModal: false, deleteUrl: '' }"
- Modal overlay with backdrop
- Confirmation text "Вы уверены? Это действие нельзя отменить."
- Cancel button and Delete form with @method('DELETE')

**Eager loading expectation:**
Template assumes $products loaded with ->with('categories') to prevent N+1

Use Tailwind classes consistent with Phase 2 admin styles.
Use Iconify icons for visual elements.
</action>
  <verify>
Check file exists and contains:
```bash
grep -n "admin.layouts.app" resources/views/admin/products/index.blade.php
grep -n "showModal" resources/views/admin/products/index.blade.php
grep -n "admin.products.create" resources/views/admin/products/index.blade.php
```
  </verify>
  <done>
Product list view exists
Extends admin layout from Phase 2
Has responsive table/card switching
Delete confirmation modal with Alpine.js
Success message banner implementation
Pagination included
  </done>
</task>

<task type="auto">
  <name>Task 3: Build Product Create/Edit Forms with Tabs</name>
  <files>
    resources/views/admin/products/create.blade.php
    resources/views/admin/products/edit.blade.php
  </files>
  <action>
Create tabbed product form (create and edit are nearly identical, edit loads existing data):

**Common structure:**
Both forms extend admin.layouts.app and use same 4-tab layout with Alpine.js

**Alpine.js form state management:**
```blade
<div x-data="productForm()">
```

**productForm() Alpine component (in script tag):**
```javascript
function productForm() {
  return {
    tab: 'basic',
    attributes: @json($product->attributes ?? [{key: '', value: ''}]),
    images: [],
    mainImageIndex: 0,

    addAttribute() {
      this.attributes.push({key: '', value: ''});
    },
    removeAttribute(index) {
      this.attributes.splice(index, 1);
    }
  }
}
```

**Tab Navigation:**
4 tabs with Alpine.js click handlers:
1. "Основное" (tab === 'basic')
2. "Фото" (tab === 'images')
3. "Характеристики" (tab === 'attributes')
4. "SEO" (tab === 'seo')

Active tab: border-b-2 border-blue-500 text-blue-600
Inactive: text-gray-500

**Tab 1: Основное (Basic Info):**
Fields:
- Название (name): required text input
- Slug: text input (pre-filled on edit, placeholder "Генерируется автоматически" on create)
- Описание (description): textarea, 4 rows
- Цена (price): number input, append "сом", value in KGS (divide by 100 on edit)
- Акционная цена (old_price): number input, nullable
- Категории: Multiple checkboxes from $categories (many-to-many)
- Статус: Checkbox "Опубликован" for is_active field

**Tab 2: Фото (Images):**
File input with multiple attribute: accept="image/jpeg,image/png,image/webp"
Instructions text: "Drag & drop или выберите файлы (макс 10 изображений, до 2MB каждое)"

On edit: Show existing images with:
- Thumbnail preview
- Radio button to select main image (name="main_image_index" value="{index}")
- "Удалить" button (marks for deletion, actual delete happens on update)

**Tab 3: Характеристики (Attributes):**
Dynamic attribute list using Alpine.js template x-for:
```blade
<template x-for="(attr, index) in attributes" :key="index">
  <div class="flex gap-2 mb-2">
    <input type="text" x-model="attr.key" :name="'attributes['+index+'][key]'" placeholder="Память, Цвет..." class="flex-1">
    <input type="text" x-model="attr.value" :name="'attributes['+index+'][value]'" placeholder="256GB, Черный..." class="flex-1">
    <button type="button" @click="removeAttribute(index)" class="text-red-600">
      <iconify-icon icon="solar:trash-bin-trash-linear"></iconify-icon>
    </button>
  </div>
</template>
```
"+ Добавить характеристику" button below list

**Tab 4: SEO:**
Fields:
- Meta Title: text input, max 200, placeholder "Название товара (если пусто)"
- Meta Description: textarea, max 300, 3 rows

**Form submission:**
POST to route('admin.products.store') for create
POST to route('admin.products.update', $product) with @method('PUT') for edit
Include @csrf directive

**Validation errors display:**
@if($errors->any())
  Show error banner at top with list of errors
@endif

**Save buttons at bottom (outside tabs):**
- "Сохранить" primary button (blue)
- "Отмена" secondary button linking back to admin.products.index

For edit.blade.php:
- Pre-fill all form fields with $product data
- Convert price from cents to KGS for display (divide by 100)
- Check category checkboxes if product has them
- Load existing attributes into Alpine state
- Show existing images with main image pre-selected

Use x-cloak on tab content to prevent flash of unstyled content:
```blade
<div x-show="tab === 'images'" x-cloak>
```

Follow CONTEXT requirement: 4 tabs, not one long page.
Use Alpine.js for dynamic attributes per RESEARCH pattern.
</action>
  <verify>
Check files contain key elements:
```bash
grep -n "x-data.*productForm" resources/views/admin/products/create.blade.php
grep -n "tab.*basic.*images.*attributes.*seo" resources/views/admin/products/create.blade.php
grep -n "addAttribute" resources/views/admin/products/create.blade.php
grep -n "x-for.*attributes" resources/views/admin/products/create.blade.php
```
  </verify>
  <done>
Create and edit forms exist with 4-tab structure
Alpine.js manages tab state and dynamic attributes
Image upload interface with main image selection
Category multiple selection (checkboxes)
Slug field editable
Price conversion KGS ↔ cents handled
Validation error display
Forms submit to correct routes with CSRF protection
  </done>
</task>

</tasks>

<verification>
**Manual browser testing required after execution:**
1. Visit /admin/products - see product list
2. Click "Добавить товар" - see 4-tab form
3. Fill Basic tab, switch to Images tab, upload 2-3 photos
4. Switch to Attributes tab, add attributes (Память: 256GB, Цвет: Черный)
5. Switch to SEO tab, add meta fields
6. Save - product created, redirects to list with success message
7. Click Edit on product - form pre-filled with all data including images
8. Modify product, save - updates successfully
9. Click Delete on product - modal appears
10. Confirm delete - product removed, images deleted from storage

**Technical verification:**
```bash
# Verify storage link exists
ls -la public/storage

# If not exists, create it
php artisan storage:link

# Test product creation via tinker
php artisan tinker
>>> App\Models\Product::count()

# Check uploaded images in storage
ls storage/app/public/products
```
</verification>

<success_criteria>
- Admin can view paginated product list with images, prices, categories
- Admin can create new product with all fields including multiple images
- Admin can select which image is main image via radio buttons
- Admin can add unlimited dynamic attributes (key-value pairs)
- Admin can edit existing product and modify all fields
- Admin can delete product with modal confirmation
- Product images stored securely in storage/app/public/products
- Deleted products have images removed from storage
- Form validation prevents invalid data (required name, valid price, image size limits)
- Success/error messages display correctly
- Slug auto-generates from name but can be manually edited
- Price stored in cents, displayed in KGS
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-panel/03-01-SUMMARY.md` using summary template.

Document:
- Controller structure and image handling approach
- Alpine.js patterns used (tabs, dynamic attributes)
- Validation rules applied
- File upload security measures (Storage facade, auto-generated names)
- Any deviations from plan or issues encountered
</output>

---
phase: 02-shopping-checkout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/create_orders_table.php
  - database/migrations/create_order_items_table.php
  - app/Models/Order.php
  - app/Models/OrderItem.php
  - app/Http/Controllers/CartController.php
  - resources/views/cart/index.blade.php
  - resources/views/components/toast.blade.php
  - routes/web.php
autonomous: true

must_haves:
  truths:
    - "Customer can add product to cart from product page"
    - "Customer can see cart page with all items and quantities"
    - "Customer can change quantity without page reload"
    - "Customer can remove item from cart"
    - "Customer sees real-time cart total updates"
    - "Cart count badge appears in header"
  artifacts:
    - path: "database/migrations/create_orders_table.php"
      provides: "Orders table schema with customer info, payment method, status, totals"
      contains: "Schema::create('orders'"
    - path: "database/migrations/create_order_items_table.php"
      provides: "Order items table with snapshot pricing"
      contains: "Schema::create('order_items'"
    - path: "app/Models/Order.php"
      provides: "Order model with status constants and relationships"
      exports: ["STATUS_NEW", "STATUS_PROCESSING", "STATUS_DELIVERING", "STATUS_COMPLETED"]
    - path: "app/Models/OrderItem.php"
      provides: "Order item model with product snapshot"
      min_lines: 15
    - path: "app/Http/Controllers/CartController.php"
      provides: "Cart CRUD operations with AJAX responses"
      exports: ["index", "add", "update", "remove"]
    - path: "resources/views/cart/index.blade.php"
      provides: "Cart page with Alpine.js quantity updates"
      min_lines: 50
    - path: "resources/views/components/toast.blade.php"
      provides: "Toast notification component for cart feedback"
      contains: "x-data"
  key_links:
    - from: "resources/views/storefront/products/show.blade.php"
      to: "/cart/add"
      via: "AJAX fetch in Alpine.js addToCart()"
      pattern: "fetch.*cart/add"
    - from: "app/Http/Controllers/CartController.php"
      to: "Cart facade"
      via: "darryldecode/cart package"
      pattern: "Cart::(add|update|remove|getContent)"
    - from: "resources/views/cart/index.blade.php"
      to: "/cart/{id}"
      via: "Alpine.js updateQuantity() AJAX"
      pattern: "fetch.*cart/"
    - from: "resources/views/layouts/app.blade.php"
      to: "Cart::getTotalQuantity()"
      via: "Cart count badge display"
      pattern: "Cart::getTotalQuantity"
---

<objective>
Create the database schema for orders and order items, then implement a fully functional shopping cart system with session-based storage using the existing darryldecode/cart package. Customers can add products to cart, view cart page, update quantities via AJAX without page reload, remove items, and see real-time total updates.

Purpose: Enable customers to collect products before checkout while providing smooth UX with instant feedback and no page reloads (CONTEXT requirement).

Output: Working cart system with database foundation for order processing, AJAX-powered cart page, toast notifications, and header cart badge.
</objective>

<execution_context>
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\user\Desktop\mi_tech\.planning\PROJECT.md
@C:\Users\user\Desktop\mi_tech\.planning\ROADMAP.md
@C:\Users\user\Desktop\mi_tech\.planning\STATE.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-CONTEXT.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-RESEARCH.md

# Reference Phase 1 patterns
@C:\Users\user\Desktop\mi_tech\.planning\phases\01-foundation-product-catalog\01-01-SUMMARY.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\01-foundation-product-catalog\01-02-SUMMARY.md

# Existing files to modify
@C:\Users\user\Desktop\mi_tech\routes\web.php
@C:\Users\user\Desktop\mi_tech\resources\views\layouts\app.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Order Database Schema</name>
  <files>
    database/migrations/2026_01_23_create_orders_table.php
    database/migrations/2026_01_23_create_order_items_table.php
    app/Models/Order.php
    app/Models/OrderItem.php
  </files>
  <action>
    Create migrations for orders and order_items tables following RESEARCH.md Pattern 2 (Order with Snapshot Pricing).

    **Orders table (create_orders_table.php):**
    - id (bigIncrements)
    - order_number (string, unique) - format: ORD-YYYYMMDD-NNNN
    - Customer fields: customer_name (string), customer_phone (string), customer_address (text)
    - payment_method (enum: cash, online, installment)
    - status (enum: new, processing, delivering, completed) - default 'new'
    - Totals in cents: subtotal (integer), total (integer)
    - timestamps

    **Order items table (create_order_items_table.php):**
    - id (bigIncrements)
    - order_id (foreignId, constrained, onDelete cascade)
    - product_id (foreignId, constrained) - reference only, not for price lookup
    - Snapshot fields: product_name (string), product_slug (string), price (integer, cents AT PURCHASE TIME), quantity (integer), subtotal (integer, price * quantity)
    - attributes (json, nullable) - e.g., {"Память": "256GB", "Цвет": "Black"}
    - timestamps

    **Order model (app/Models/Order.php):**
    - Fillable: all fields except id/timestamps
    - Casts: subtotal, total as integer
    - Relationship: hasMany(OrderItem::class, 'items')
    - Status constants: STATUS_NEW, STATUS_PROCESSING, STATUS_DELIVERING, STATUS_COMPLETED
    - Static method statusLabels(): array returning Russian labels per CONTEXT
    - Accessor getFormattedTotalAttribute(): string (cents to "X сом" format)
    - Scope scopeRecent($query) for admin list

    **OrderItem model (app/Models/OrderItem.php):**
    - Fillable: all fields except id/timestamps
    - Casts: price, quantity, subtotal as integer; attributes as array
    - Relationship: belongsTo(Order::class)
    - Relationship: belongsTo(Product::class) - for admin reference only

    Use exact patterns from RESEARCH.md code examples (lines 164-206). Don't add soft deletes or unnecessary fields.
  </action>
  <verify>
    php artisan migrate
    Check tables exist: SHOW TABLES LIKE 'orders'; SHOW TABLES LIKE 'order_items';
    Check model loads: php artisan tinker -> Order::STATUS_NEW; -> exit
  </verify>
  <done>
    Migrations run successfully, orders and order_items tables created with correct schema, Order and OrderItem models load without errors, status constants accessible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Cart Controller with AJAX Support</name>
  <files>
    app/Http/Controllers/CartController.php
    routes/web.php
  </files>
  <action>
    Create CartController following RESEARCH.md Pattern 1 (Session-Based Cart for Guests).

    **CartController methods:**

    1. **index()** - Display cart page
       - $items = Cart::getContent()
       - $total = Cart::getTotal()
       - Return view('cart.index', compact('items', 'total'))

    2. **add(Request $request)** - Add to cart (AJAX, stay on current page)
       - Validate: product_id (required, exists:products), quantity (nullable, integer, min:1)
       - Load product: Product::findOrFail($request->product_id)
       - Cart::add(['id' => product->id, 'name' => product->name, 'price' => product->price / 100 (convert cents to decimal), 'quantity' => $request->quantity ?? 1, 'attributes' => ['slug' => product->slug, 'image' => product->image]])
       - Return JSON: {success: true, cart_count: Cart::getTotalQuantity(), message: 'Товар добавлен в корзину'}
       - NOTE: darryldecode/cart expects decimal price (it handles cents internally), so divide by 100 when adding

    3. **update(Request $request, $itemId)** - Update quantity (AJAX, no page reload)
       - Validate: quantity (required, integer, min:1)
       - Cart::update($itemId, ['quantity' => ['relative' => false, 'value' => $request->quantity]])
       - Return JSON: {success: true, subtotal: Cart::getSubTotal(), total: Cart::getTotal(), cart_count: Cart::getTotalQuantity()}

    4. **remove($itemId)** - Remove item (AJAX)
       - Cart::remove($itemId)
       - Return JSON: {success: true, total: Cart::getTotal(), cart_count: Cart::getTotalQuantity(), message: 'Товар удален из корзины'}

    **Routes in web.php:**
    - GET /cart -> CartController@index, name('cart.index')
    - POST /cart/add -> CartController@add, name('cart.add')
    - PATCH /cart/{itemId} -> CartController@update, name('cart.update')
    - DELETE /cart/{itemId} -> CartController@remove, name('cart.remove')

    Use exact patterns from RESEARCH.md lines 100-153. Include use Cart; at top. Handle errors gracefully with try-catch returning JSON errors.
  </action>
  <verify>
    php artisan route:list --path=cart
    Verify 4 routes exist: cart.index (GET), cart.add (POST), cart.update (PATCH), cart.remove (DELETE)
    Check controller compiles: php artisan tinker -> new App\Http\Controllers\CartController; -> exit
  </verify>
  <done>
    CartController created with all 4 methods, routes registered in web.php, controller compiles without errors, routes appear in route list.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build Cart Page with Alpine.js AJAX Updates</name>
  <files>
    resources/views/cart/index.blade.php
    resources/views/components/toast.blade.php
    resources/views/layouts/app.blade.php
    resources/views/storefront/products/show.blade.php
  </files>
  <action>
    Create cart page with Alpine.js for AJAX quantity updates following RESEARCH.md Pattern 4 (lines 273-334).

    **Cart page (resources/views/cart/index.blade.php):**
    - Extend layouts.app
    - Title: "Корзина"
    - If cart empty: Show empty state with message "Ваша корзина пуста" and link to /products
    - If cart has items:
      - Use Alpine.js x-data="cartManager()" with quantities, total, formatPrice(), updateQuantity(), removeItem() methods
      - Display each item: product image, name (link to product), price per unit, quantity input (type=number, x-model, @change triggers updateQuantity), subtotal, remove button (@click triggers removeItem)
      - Quantity input: min="1", debounce updates
      - Total section: "Итого: X сом", "Оформить заказ" button linking to /checkout
      - Include CSRF meta tag in head: <meta name="csrf-token" content="{{ csrf_token() }}">
      - Alpine.js script: fetch PATCH /cart/{itemId} with JSON {quantity: newQty}, update totals on response, dispatch 'cart-updated' event to header
      - Remove: fetch DELETE /cart/{itemId}, remove item from DOM on success

    **Toast component (resources/views/components/toast.blade.php):**
    - Create reusable Alpine.js toast following RESEARCH.md lines 641-679
    - Listen for @cart-added.window and @cart-removed.window events
    - Auto-dismiss after 3 seconds
    - Support success/error types with Tailwind colors
    - Fixed bottom-right position

    **Update app layout header (resources/views/layouts/app.blade.php):**
    - Add cart icon with badge showing Cart::getTotalQuantity() in header nav
    - Link to /cart
    - Badge: small circle with count, hidden if count = 0
    - Listen for 'cart-updated' event via Alpine.js to update count without page reload

    **Update product detail page (resources/views/storefront/products/show.blade.php):**
    - Add "Добавить в корзину" button (if not already present from Phase 1 placeholder)
    - Button uses Alpine.js @click="addToCart({{ $product->id }})"
    - JavaScript function addToCart(productId): fetch POST /cart/add with JSON, dispatch 'cart-added' event on success, update header badge
    - Include X-CSRF-TOKEN header in fetch requests

    Use Tailwind CSS for styling matching existing site design. Follow RESEARCH.md examples for Alpine.js patterns. Ensure all AJAX requests include CSRF token.
  </action>
  <verify>
    Visit /cart in browser - should show empty state or items if cart has data
    Add product from /products/{slug} - should stay on page, show toast, update header badge
    On /cart page, change quantity - should update totals without page reload
    Remove item - should disappear from list without page reload
    Check browser console for errors (should be none)
  </verify>
  <done>
    Cart page displays correctly with empty state and item list, AJAX quantity updates work without page reload, remove button works, toast notifications appear on add/remove, header cart badge shows correct count and updates in real-time, no console errors.
  </done>
</task>

</tasks>

<verification>
**Functional tests:**
1. Add product to cart from product detail page - stays on page, shows toast, header badge increments
2. Visit /cart - see added products with correct prices and quantities
3. Change quantity on cart page - total updates without page reload, header badge updates
4. Remove item from cart - item disappears, total recalculates, header badge decrements
5. Empty cart - shows "Ваша корзина пуста" message with link to products

**Database verification:**
1. php artisan migrate - runs without errors
2. Check orders table schema: DESCRIBE orders;
3. Check order_items table schema: DESCRIBE order_items;
4. Verify Order model constants: php artisan tinker -> Order::statusLabels();

**Code quality:**
1. Routes exist: php artisan route:list --path=cart
2. No syntax errors: php artisan tinker -> new App\Http\Controllers\CartController;
3. Cart facade works: php artisan tinker -> Cart::getContent();
4. CSRF tokens present in all AJAX requests (check browser Network tab)
</verification>

<success_criteria>
**Requirements covered:**
- CART-01: Customer can add product to cart ✓
- CART-02: Customer can change quantity ✓
- CART-03: Customer can remove item ✓
- CART-04: Customer sees cart total ✓

**Observable behaviors:**
- Adding to cart shows toast notification and stays on current page
- Cart page displays all items with correct prices (from product table via Cart facade)
- Quantity changes update totals instantly without page reload
- Remove button deletes item without page reload
- Header badge shows accurate cart count and updates in real-time
- Empty cart shows helpful message with navigation

**Technical criteria:**
- Orders/order_items tables exist with correct schema (snapshot pricing pattern)
- Cart facade operations work (add, update, remove, getContent, getTotal)
- AJAX requests include CSRF token and return JSON
- Alpine.js manages client-side state reactivity
- No JavaScript console errors
- Session persistence: cart survives page navigation
</success_criteria>

<output>
After completion, create `.planning/phases/02-shopping-checkout/02-01-SUMMARY.md` using the summary template.

Include:
- Database schema created (orders, order_items tables)
- Cart functionality (add, update, remove with AJAX)
- UI components (cart page, toast notifications, header badge)
- Patterns established (session-based cart, Alpine.js AJAX, CSRF handling)
- Dependencies for next plans (checkout can now create orders, admin can view orders)
</output>

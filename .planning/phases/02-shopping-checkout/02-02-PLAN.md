---
phase: 02-shopping-checkout
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - composer.json
  - app/Http/Requests/CheckoutRequest.php
  - app/Http/Controllers/CheckoutController.php
  - resources/views/checkout/index.blade.php
  - resources/views/checkout/success.blade.php
  - routes/web.php
  - app/Providers/AppServiceProvider.php
autonomous: true

user_setup:
  - service: propaganistas/laravel-phone
    why: "Phone validation for Kyrgyzstan (+996 format)"
    installation: "composer require propaganistas/laravel-phone"
    note: "Claude will install this package automatically"

must_haves:
  truths:
    - "Customer with items in cart can access checkout page"
    - "Customer sees checkout form with required fields (name, phone, address, payment method)"
    - "Customer cannot submit invalid phone number (must be +996 format)"
    - "Customer can select payment method (cash, online, installment)"
    - "Customer receives order confirmation with unique order number after submission"
    - "Order is created in database with customer info and cart items snapshot"
    - "Cart is cleared after successful order creation"
    - "Customer cannot spam checkout form (rate limited to 3 per 10 minutes)"
  artifacts:
    - path: "app/Http/Requests/CheckoutRequest.php"
      provides: "Form validation with phone:KG rule"
      contains: "'phone' => ['required', 'phone:KG']"
    - path: "app/Http/Controllers/CheckoutController.php"
      provides: "Checkout form display and atomic order creation"
      exports: ["index", "process"]
    - path: "resources/views/checkout/index.blade.php"
      provides: "Single-page checkout form"
      min_lines: 80
    - path: "resources/views/checkout/success.blade.php"
      provides: "Order confirmation page"
      contains: "order_number"
    - path: "app/Providers/AppServiceProvider.php"
      provides: "Rate limiter configuration for checkout"
      contains: "RateLimiter::for('checkout'"
  key_links:
    - from: "resources/views/checkout/index.blade.php"
      to: "/checkout"
      via: "Form POST submission"
      pattern: "action.*route.*checkout.process"
    - from: "app/Http/Controllers/CheckoutController.php"
      to: "DB::transaction()"
      via: "Atomic order creation with rollback"
      pattern: "DB::transaction\\(function"
    - from: "app/Http/Controllers/CheckoutController.php"
      to: "Cart facade"
      via: "Get items for order creation, clear after success"
      pattern: "Cart::(getContent|getSubTotal|getTotal|clear)"
    - from: "app/Http/Controllers/CheckoutController.php"
      to: "Order model"
      via: "Create order with items in transaction"
      pattern: "Order::create|\\$order->items\\(\\)->create"
---

<objective>
Implement guest checkout with single-page form collecting minimal customer information (name, phone, address, payment method), strict validation including Kyrgyzstan phone format, atomic order creation with price snapshot, and rate limiting to prevent spam. After successful checkout, customer sees order confirmation and cart is cleared.

Purpose: Enable customers to complete purchases without registration (CONTEXT: гостевой checkout) while ensuring data quality through validation and preventing abuse through rate limiting.

Output: Working checkout flow from cart to order confirmation, with validated customer data, atomic database transactions, and spam protection.
</objective>

<execution_context>
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-01-SUMMARY.md
</execution_context>

<context>
@C:\Users\user\Desktop\mi_tech\.planning\PROJECT.md
@C:\Users\user\Desktop\mi_tech\.planning\ROADMAP.md
@C:\Users\user\Desktop\mi_tech\.planning\STATE.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-CONTEXT.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-RESEARCH.md

# Existing files to modify
@C:\Users\user\Desktop\mi_tech\routes\web.php
@C:\Users\user\Desktop\mi_tech\app\Providers\AppServiceProvider.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Phone Validation Package</name>
  <files>
    composer.json
  </files>
  <action>
    Install propaganistas/laravel-phone package for Kyrgyzstan phone validation following RESEARCH.md.

    Run: composer require propaganistas/laravel-phone

    This package provides 'phone:KG' validation rule for +996 country code with proper E.164 format validation. After install, verify package appears in composer.json require section.

    NOTE: This is standard Laravel package installation - no additional configuration needed, validation rule works immediately after install.
  </action>
  <verify>
    composer show propaganistas/laravel-phone
    Check package installed and version displayed
  </verify>
  <done>
    Package propaganistas/laravel-phone installed successfully and appears in composer.json, ready to use phone:KG validation rule.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Checkout Form Request and Controller</name>
  <files>
    app/Http/Requests/CheckoutRequest.php
    app/Http/Controllers/CheckoutController.php
    routes/web.php
    app/Providers/AppServiceProvider.php
  </files>
  <action>
    Create checkout request validation and controller following RESEARCH.md Pattern 3 (Atomic Order Creation) and Pattern 5 (Rate Limiting).

    **CheckoutRequest (app/Http/Requests/CheckoutRequest.php):**
    - Create FormRequest class
    - authorize(): return true (guest checkout, no auth required)
    - rules(): return [
        'name' => ['required', 'string', 'min:2', 'max:255'],
        'phone' => ['required', 'phone:KG'],
        'address' => ['required', 'string', 'min:10', 'max:500'],
        'payment_method' => ['required', 'in:cash,online,installment']
      ]
    - messages(): return Russian error messages per RESEARCH.md lines 506-515
      - 'name.required' => 'Укажите ваше имя'
      - 'phone.required' => 'Укажите номер телефона'
      - 'phone.phone' => 'Неверный формат телефона. Используйте +996 XXX XXX XXX'
      - 'address.required' => 'Укажите адрес доставки'
      - 'payment_method.required' => 'Выберите способ оплаты'

    **CheckoutController (app/Http/Controllers/CheckoutController.php):**

    1. **index()** - Display checkout form
       - Check cart not empty: if (Cart::getTotalQuantity() === 0) return redirect()->route('cart.index')->withErrors('Ваша корзина пуста')
       - $items = Cart::getContent()
       - $total = Cart::getTotal()
       - Return view('checkout.index', compact('items', 'total'))

    2. **process(CheckoutRequest $request)** - Create order atomically
       - Use DB::transaction() wrapping all operations (RESEARCH.md lines 216-260)
       - Inside transaction:
         a. Create order: Order::create([...]) with order_number from generateOrderNumber(), customer fields from request, payment_method, status='new', subtotal/total from Cart converted to cents (* 100)
         b. Create order items: foreach Cart::getContent() as $item: $order->items()->create([product_id, product_name, product_slug, price in cents, quantity, subtotal in cents, attributes as json])
         c. Clear cart: Cart::clear()
       - Return order from transaction
       - On success: return redirect()->route('checkout.success', $order->order_number)
       - On exception: return back()->withErrors('Ошибка при оформлении заказа. Попробуйте снова.')->withInput()

    3. **generateOrderNumber()** - Private method
       - Format: ORD-YYYYMMDD-NNNN
       - $date = now()->format('Ymd')
       - $count = Order::whereDate('created_at', now())->count() + 1
       - return sprintf('ORD-%s-%04d', $date, $count)

    4. **success($orderNumber)** - Show confirmation
       - $order = Order::where('order_number', $orderNumber)->firstOrFail()
       - Return view('checkout.success', compact('order'))

    **Routes (web.php):**
    - GET /checkout -> CheckoutController@index, name('checkout.index')
    - POST /checkout -> CheckoutController@process, middleware(['throttle:checkout']), name('checkout.process')
    - GET /checkout/success/{orderNumber} -> CheckoutController@success, name('checkout.success')

    **Rate Limiter (app/Providers/AppServiceProvider.php boot()):**
    - Add RateLimiter::for('checkout', function (Request $request) { return [Limit::perMinutes(10, 3)->by($request->ip()), Limit::perMinutes(2, 1)->by($request->input('phone'))]; });
    - Import: use Illuminate\Cache\RateLimiting\Limit; use Illuminate\Support\Facades\RateLimiter; use Illuminate\Http\Request;
    - This limits checkout to 3 attempts per 10 minutes per IP, and 1 attempt per 2 minutes per phone number (SEC-05 requirement)

    Use exact transaction pattern from RESEARCH.md lines 216-266. Ensure price conversion to cents (* 100) when storing in database.
  </action>
  <verify>
    php artisan route:list --path=checkout
    Verify 3 routes: checkout.index (GET), checkout.process (POST with throttle), checkout.success (GET)
    Check request compiles: php artisan tinker -> new App\Http\Requests\CheckoutRequest; -> exit
    Check controller compiles: php artisan tinker -> new App\Http\Controllers\CheckoutController; -> exit
  </verify>
  <done>
    CheckoutRequest created with phone:KG validation and Russian messages, CheckoutController created with index/process/success methods, routes registered with rate limiting middleware, rate limiter configured in AppServiceProvider, all files compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build Checkout Views</name>
  <files>
    resources/views/checkout/index.blade.php
    resources/views/checkout/success.blade.php
  </files>
  <action>
    Create checkout form and success page following CONTEXT (single-page checkout, minimal fields).

    **Checkout form (resources/views/checkout/index.blade.php):**
    - Extend layouts.app
    - Title: "Оформление заказа"
    - Layout: Two columns on desktop (order summary left, form right), single column on mobile
    - Left column - Order summary:
      - "Ваш заказ" heading
      - List cart items: image thumbnail, name, quantity, subtotal
      - Total: "Итого: {{ number_format($total, 0, ',', ' ') }} сом"
    - Right column - Checkout form:
      - Form POST to route('checkout.process')
      - @csrf
      - Field: Имя (name, text input, required, autofocus, old('name'))
      - Field: Телефон (phone, text input, required, placeholder="+996 XXX XXX XXX", old('phone'))
      - Field: Адрес доставки (address, textarea, required, rows=3, old('address'))
      - Field: Способ оплаты (payment_method, select dropdown with options):
        - <option value="cash" {{ old('payment_method') === 'cash' ? 'selected' : '' }}>Наличными при получении</option>
        - <option value="online" {{ old('payment_method') === 'online' ? 'selected' : '' }}>Онлайн оплата картой</option>
        - <option value="installment" {{ old('payment_method') === 'installment' ? 'selected' : '' }}>Рассрочка</option>
      - Display validation errors with @error directives for each field
      - Submit button: "Оформить заказ" (primary style)
      - Link back to cart: "Вернуться к корзине"
    - Use Tailwind CSS classes matching site design
    - Mobile responsive: stack columns, full-width inputs

    **Success page (resources/views/checkout/success.blade.php):**
    - Extend layouts.app
    - Title: "Заказ оформлен"
    - Success message: "Спасибо за ваш заказ!"
    - Display order details:
      - "Номер заказа: {{ $order->order_number }}"
      - "Сумма: {{ $order->formatted_total }}" (uses accessor from Order model)
      - "Статус: {{ Order::statusLabels()[$order->status] }}"
      - Customer info: name, phone, address
      - Order items list: product name, quantity, price
    - Next steps text: "Мы свяжемся с вами в ближайшее время для подтверждения заказа."
    - Link to continue shopping: "Вернуться к покупкам" -> route('products.index')
    - Use success/confirmation design pattern (green accent, checkmark icon if available)

    Include proper error display, preserve form data on validation failure with old(), use Russian labels per CONTEXT.
  </action>
  <verify>
    Visit /checkout with empty cart - should redirect to /cart with error
    Add items to cart, visit /checkout - should show form with cart summary
    Submit form with invalid phone (e.g., "123") - should show validation error "Неверный формат телефона"
    Submit valid form - should create order and redirect to /checkout/success/{orderNumber}
    Success page should display order number, total, customer info, and items
    Check order created in database: php artisan tinker -> Order::latest()->first();
    Check cart cleared: Cart::getTotalQuantity() should be 0 after checkout
  </verify>
  <done>
    Checkout form displays with cart summary and all required fields, phone validation works with Russian error messages, order creation succeeds and redirects to success page, success page shows order number and details, cart is cleared after checkout, order appears in database with correct data.
  </done>
</task>

</tasks>

<verification>
**Functional tests:**
1. Visit /checkout with empty cart - redirects to /cart with error message
2. Add products to cart, visit /checkout - shows form with order summary
3. Submit form with invalid data (empty fields, wrong phone format) - shows validation errors in Russian
4. Submit valid form with phone +996 555 123 456 - creates order, clears cart, redirects to success
5. Success page displays order number (ORD-20260123-0001 format) and all order details
6. Try to submit 4 checkout forms rapidly - 4th attempt blocked by rate limiter (429 response)

**Database verification:**
1. Order created with status='new': SELECT * FROM orders ORDER BY created_at DESC LIMIT 1;
2. Order items created with snapshot prices: SELECT * FROM order_items WHERE order_id = (last order id);
3. Prices stored in cents (e.g., 10000 for 100 сом): Check subtotal/total fields
4. Customer phone in E.164 format: Check customer_phone field starts with +996

**Code quality:**
1. Rate limiter works: php artisan tinker -> RateLimiter::for('checkout', ...); (no errors)
2. Transaction rollback on error: Manually throw exception in process() method, verify order not created
3. Phone validation accepts +996 format: Test with various valid/invalid numbers
4. Form preserves data on validation failure: Submit invalid form, check inputs retain values
</verification>

<success_criteria>
**Requirements covered:**
- CART-05: Guest checkout without registration ✓
- CART-06: Cash on delivery payment method ✓
- CART-07: Online payment selection (placeholder) ✓
- CART-08: Installment selection (placeholder) ✓
- CART-09: Order confirmation with number ✓
- ORD-05: Customer info stored ✓
- ORD-06: Order items with snapshot prices ✓
- SEC-05: Rate limiting for forms ✓

**Observable behaviors:**
- Checkout form appears only when cart has items
- Phone validation enforces +996 Kyrgyzstan format
- Invalid submissions show clear Russian error messages
- Valid submissions create order atomically (all-or-nothing)
- Order confirmation displays unique order number and details
- Cart empties after successful checkout
- Rapid submissions blocked by rate limiter (3 per 10 minutes per IP)

**Technical criteria:**
- Order and order items created in single transaction
- Price snapshot: order_items.price frozen at purchase time
- Phone stored in E.164 format (+996XXXXXXXXX)
- Prices stored as integer cents in database
- Cart cleared only after successful order creation
- Rate limiter configured with multiple limits (IP and phone)
- No partial orders possible (transaction ensures atomicity)
</success_criteria>

<output>
After completion, create `.planning/phases/02-shopping-checkout/02-02-SUMMARY.md` using the summary template.

Include:
- Checkout flow (form validation, order creation, confirmation)
- Phone validation with propaganistas/laravel-phone package
- Atomic transaction pattern preventing partial orders
- Rate limiting configuration (SEC-05 compliance)
- Dependencies for next plan (admin can now view created orders)
</output>

---
phase: 02-shopping-checkout
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - app/Http/Controllers/Admin/OrderController.php
  - resources/views/admin/orders/index.blade.php
  - resources/views/admin/orders/show.blade.php
  - resources/views/admin/layouts/app.blade.php
  - routes/web.php
autonomous: true

must_haves:
  truths:
    - "Administrator can see list of all orders sorted by newest first"
    - "Administrator can click order to see full details"
    - "Administrator can see customer contact information for each order"
    - "Administrator can see what products were ordered with quantities and prices"
    - "Administrator can change order status from dropdown"
    - "Administrator sees count of new orders in admin header"
    - "Order list shows order number, customer name, total, status, date"
  artifacts:
    - path: "app/Http/Controllers/Admin/OrderController.php"
      provides: "Admin order list, detail view, status update"
      exports: ["index", "show", "updateStatus"]
    - path: "resources/views/admin/orders/index.blade.php"
      provides: "Paginated order list with filters"
      min_lines: 60
    - path: "resources/views/admin/orders/show.blade.php"
      provides: "Order detail page with status update form"
      min_lines: 80
    - path: "resources/views/admin/layouts/app.blade.php"
      provides: "Admin layout with new orders badge"
      contains: "Order::where('status', 'new')->count()"
  key_links:
    - from: "resources/views/admin/orders/index.blade.php"
      to: "route('admin.orders.show')"
      via: "Order row links to detail page"
      pattern: "route\\('admin\\.orders\\.show'"
    - from: "app/Http/Controllers/Admin/OrderController.php"
      to: "Order model with items"
      via: "Eager loading to prevent N+1"
      pattern: "Order::with\\('items'\\)"
    - from: "resources/views/admin/orders/show.blade.php"
      to: "/admin/orders/{id}/status"
      via: "Form POST to update status"
      pattern: "route\\('admin\\.orders\\.updateStatus'"
    - from: "app/Http/Controllers/Admin/OrderController.php"
      to: "Order::statusLabels()"
      via: "Display Russian status labels"
      pattern: "Order::statusLabels"
---

<objective>
Build admin panel order management interface allowing administrators to view all orders, see detailed customer and product information, and update order statuses. Admin receives visual notification of new orders via header badge.

Purpose: Enable administrator to process orders and track their progress through fulfillment lifecycle (ORD-01, ORD-02, ORD-03, ORD-04 requirements).

Output: Complete admin order management system with list view, detail view, status updates, and new order notifications.
</objective>

<execution_context>
@C:\Users\user\Desktop\mi_tech\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-01-SUMMARY.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-02-SUMMARY.md
</execution_context>

<context>
@C:\Users\user\Desktop\mi_tech\.planning\PROJECT.md
@C:\Users\user\Desktop\mi_tech\.planning\ROADMAP.md
@C:\Users\user\Desktop\mi_tech\.planning\STATE.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-CONTEXT.md
@C:\Users\user\Desktop\mi_tech\.planning\phases\02-shopping-checkout\02-RESEARCH.md

# Reference Phase 1 admin patterns
@C:\Users\user\Desktop\mi_tech\.planning\phases\01-foundation-product-catalog\01-01-SUMMARY.md

# Existing files to check for admin layout
@C:\Users\user\Desktop\mi_tech\routes\web.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Admin Order Controller</name>
  <files>
    app/Http/Controllers/Admin/OrderController.php
    routes/web.php
  </files>
  <action>
    Create admin order controller following RESEARCH.md lines 592-637 (Admin Order Controller pattern).

    **OrderController (app/Http/Controllers/Admin/OrderController.php):**

    - Namespace: App\Http\Controllers\Admin
    - Extend Controller
    - Constructor with middleware: $this->middleware('auth'); (assumes admin auth from Phase 1)

    **Methods:**

    1. **index()** - List all orders with pagination
       - Query: $orders = Order::with('items.product')->recent()->paginate(20);
       - Eager load items and products to prevent N+1 queries
       - Use scopeRecent from Order model (orderBy created_at desc)
       - Pagination at 20 items (consistent with Phase 1 decision)
       - Return view('admin.orders.index', compact('orders'))

    2. **show(Order $order)** - Display order details
       - Use route model binding (automatic)
       - Eager load relationships: $order->load('items.product');
       - Return view('admin.orders.show', compact('order'))

    3. **updateStatus(Request $request, Order $order)** - Change order status
       - Validate: $request->validate(['status' => ['required', 'in:new,processing,delivering,completed']]);
       - Update: $order->update(['status' => $request->status]);
       - Return: back()->with('success', 'Статус заказа обновлен');

    **Routes (web.php):**
    - Group with prefix 'admin', middleware 'auth', name 'admin.':
      - GET /admin/orders -> OrderController@index, name('orders.index')
      - GET /admin/orders/{order} -> OrderController@show, name('orders.show')
      - POST /admin/orders/{order}/status -> OrderController@updateStatus, name('orders.updateStatus')

    Use exact pattern from RESEARCH.md. Import Order model at top. Follow Phase 1 admin routing conventions if they exist.
  </action>
  <verify>
    php artisan route:list --path=admin/orders
    Verify 3 routes: admin.orders.index (GET), admin.orders.show (GET), admin.orders.updateStatus (POST)
    Check controller compiles: php artisan tinker -> new App\Http\Controllers\Admin\OrderController; -> exit
  </verify>
  <done>
    Admin OrderController created with index/show/updateStatus methods, routes registered under admin prefix with auth middleware, controller compiles without errors, routes appear in list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Admin Order List View</name>
  <files>
    resources/views/admin/orders/index.blade.php
    resources/views/admin/layouts/app.blade.php
  </files>
  <action>
    Create admin order list view and update admin layout with new orders badge.

    **Order list view (resources/views/admin/orders/index.blade.php):**

    - Check if admin layout exists (resources/views/admin/layouts/app.blade.php from Phase 1)
    - If exists: @extends('admin.layouts.app')
    - If not exists: Create minimal admin layout extending main layouts.app with admin navigation (Orders, Products, Categories, Settings links)
    - Page title: "Заказы"
    - Display orders in table:
      - Headers: Номер заказа, Клиент, Телефон, Сумма, Статус, Дата, Действия
      - For each order row:
        - Order number (link to detail page)
        - Customer name
        - Customer phone
        - Total formatted: {{ number_format($order->total / 100, 0, ',', ' ') }} сом
        - Status badge with color based on status:
          - new = blue/gray (Новый)
          - processing = yellow (В обработке)
          - delivering = orange (Доставляется)
          - completed = green (Выполнен)
        - Date formatted: {{ $order->created_at->format('d.m.Y H:i') }}
        - Actions: "Просмотреть" link to route('admin.orders.show', $order)
    - Pagination: {{ $orders->links() }} below table
    - Empty state: If no orders, show "Заказов пока нет"
    - Use Tailwind CSS table styling matching admin design
    - Mobile responsive: stack table or use cards on small screens

    **Admin layout update (resources/views/admin/layouts/app.blade.php):**

    - If layout doesn't exist, create it:
      - Extend main layouts.app
      - Add admin navigation sidebar or top nav with links:
        - Dashboard (if exists)
        - Заказы -> route('admin.orders.index')
        - Товары (link to products admin - Phase 3)
        - Категории (link to categories admin - Phase 3)
        - Настройки (placeholder)
        - Выйти -> logout route
    - Add new orders badge to "Заказы" nav link:
      - @php $newOrdersCount = \App\Models\Order::where('status', 'new')->count(); @endphp
      - If $newOrdersCount > 0: Show badge with count
      - Badge style: small circle, red/orange background, white text
    - Position badge on top-right of "Заказы" link

    Follow Phase 1 admin design patterns if established. Use Russian labels per CONTEXT.
  </action>
  <verify>
    Login to admin panel at /admin (or admin route from Phase 1)
    Click "Заказы" link - should navigate to /admin/orders
    Order list displays with all columns populated
    Status badges show correct colors and Russian labels
    Click order number - navigates to detail page
    Check new orders badge appears in navigation if new orders exist
    Create test order via checkout - badge count increments
  </verify>
  <done>
    Admin order list displays with table showing order number, customer info, total, status, date, order list is paginated at 20 items, status badges show correct colors and labels, new orders badge appears in admin navigation, clicking order navigates to detail page.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build Admin Order Detail View</name>
  <files>
    resources/views/admin/orders/show.blade.php
  </files>
  <action>
    Create admin order detail page with full information and status update form.

    **Order detail view (resources/views/admin/orders/show.blade.php):**

    - Extend admin.layouts.app (or main layout if admin layout doesn't exist)
    - Page title: "Заказ {{ $order->order_number }}"
    - Back link: "← Все заказы" to route('admin.orders.index')
    - Layout: Two columns on desktop (order info left, customer info right)

    **Left column - Order information:**
    - Order number: {{ $order->order_number }}
    - Order date: {{ $order->created_at->format('d.m.Y в H:i') }}
    - Current status with badge: {{ Order::statusLabels()[$order->status] }}
    - Payment method:
      - cash = "Наличными при получении"
      - online = "Онлайн оплата картой"
      - installment = "Рассрочка"
    - Order items table:
      - Headers: Товар, Цена, Количество, Сумма
      - For each item:
        - Product name (link to product page if available: route('products.show', item->product_slug))
        - Price: {{ number_format($item->price / 100, 0, ',', ' ') }} сом
        - Quantity: {{ $item->quantity }}
        - Subtotal: {{ number_format($item->subtotal / 100, 0, ',', ' ') }} сом
        - If attributes exist: Display as small text below name (e.g., "Память: 256GB, Цвет: Black")
    - Subtotal: {{ number_format($order->subtotal / 100, 0, ',', ' ') }} сом
    - Total: {{ number_format($order->total / 100, 0, ',', ' ') }} сом (bold, larger text)

    **Right column - Customer information:**
    - Customer details card:
      - "Информация о клиенте" heading
      - Name: {{ $order->customer_name }}
      - Phone: {{ $order->customer_phone }} (make it clickable tel: link)
      - Address: {{ $order->customer_address }} (preserve line breaks with nl2br if needed)

    **Status update form:**
    - "Изменить статус заказа" heading
    - Form POST to route('admin.orders.updateStatus', $order)
    - @csrf
    - Select dropdown with current status selected:
      @foreach(Order::statusLabels() as $value => $label)
        <option value="{{ $value }}" {{ $order->status === $value ? 'selected' : '' }}>{{ $label }}</option>
      @endforeach
    - Submit button: "Обновить статус"
    - Display success message if session has 'success': @if(session('success')) ... @endif

    Use Tailwind CSS styling, cards/boxes for visual separation, responsive layout (stack columns on mobile).
  </action>
  <verify>
    Login to admin, navigate to /admin/orders
    Click any order number - navigates to /admin/orders/{id}
    Detail page displays order number, date, status, payment method
    Items table shows correct products, prices (from snapshot, not current), quantities
    Customer section shows name, phone (as clickable link), address
    Status dropdown shows current status selected
    Change status to different value, submit - page reloads with success message
    Check order status updated in database: php artisan tinker -> Order::find({id})->status;
    Click product name - navigates to storefront product page
    Click phone number - opens phone dialer (tel: link)
  </verify>
  <done>
    Order detail page displays all order information correctly, order items show snapshot prices (frozen at purchase time), customer info visible with clickable phone link, status update form works and changes order status, success message appears after update, prices displayed in KGS format with proper thousands separator.
  </done>
</task>

</tasks>

<verification>
**Functional tests:**
1. Admin login and navigate to /admin/orders - list displays with all orders
2. Order list shows correct data (number, customer, total, status, date)
3. Status badges display correct colors (new=blue, processing=yellow, delivering=orange, completed=green)
4. New orders badge in navigation shows count of orders with status='new'
5. Click order - navigates to detail page with full information
6. Order items show snapshot prices (not current product prices)
7. Change order status via dropdown - updates successfully with Russian confirmation message
8. Create new order via checkout - appears in admin list immediately

**Data integrity verification:**
1. Order items display prices from order_items.price (snapshot), not products.price
2. Totals match sum of item subtotals
3. Customer phone displays in readable format (+996 XXX XXX XXX)
4. Status labels shown in Russian using Order::statusLabels()

**Code quality:**
1. No N+1 queries: Check with Laravel Debugbar - orders list should load items in 2 queries max
2. Pagination works: Test with >20 orders
3. Route model binding works: Access /admin/orders/999 (non-existent) - should 404
4. Auth middleware works: Logout and access /admin/orders - should redirect to login
</verification>

<success_criteria>
**Requirements covered:**
- ORD-01: Admin receives notification (new orders badge) ✓
- ORD-02: Admin can view order list ✓
- ORD-03: Admin can view order details ✓
- ORD-04: Admin can change order status ✓

**Observable behaviors:**
- Admin sees all orders sorted by newest first
- Order list is paginated and easy to scan
- New orders clearly marked with badge in navigation
- Order detail page shows complete information (customer, items, totals)
- Status update is simple (dropdown + submit)
- Success feedback appears after status change
- Prices display in local format (KGS with spaces)
- Phone numbers are clickable for easy contact

**Technical criteria:**
- Eager loading prevents N+1 query problem
- Route model binding used for clean URLs
- Snapshot prices displayed (order_items.price, not products.price)
- Status validation ensures only valid statuses accepted
- Auth middleware protects admin routes
- Russian labels throughout interface
- Pagination consistent with Phase 1 (20 items)
- Mobile responsive layout
</success_criteria>

<output>
After completion, create `.planning/phases/02-shopping-checkout/02-03-SUMMARY.md` using the summary template.

Include:
- Admin order management system (list, detail, status updates)
- New orders notification badge
- Eager loading pattern for performance
- Russian interface labels
- Phase 2 completion: Shopping cart and checkout fully functional
</output>

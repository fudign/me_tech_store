---
phase: 01-foundation-product-catalog
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - routes/web.php
  - app/Http/Controllers/Storefront/HomeController.php
  - app/Http/Controllers/Storefront/ProductController.php
  - app/Http/Controllers/Storefront/CategoryController.php
  - resources/views/layouts/app.blade.php
  - resources/views/storefront/home.blade.php
  - resources/views/storefront/products/index.blade.php
  - resources/views/storefront/products/show.blade.php
  - resources/views/storefront/categories/show.blade.php
autonomous: true

must_haves:
  truths:
    - "Customer can see homepage with product listings"
    - "Customer can click category and see filtered products"
    - "Customer can view product detail page with specifications and images"
    - "Product URLs are SEO-friendly with slugs"
    - "Site displays correctly on mobile, tablet, and desktop"
  artifacts:
    - path: "resources/views/storefront/products/show.blade.php"
      provides: "Product detail page with specs, images, price"
      min_lines: 40
    - path: "app/Http/Controllers/Storefront/ProductController.php"
      provides: "Product listing and detail actions"
      exports: ["index", "show"]
    - path: "routes/web.php"
      provides: "SEO-friendly routes with slugs"
      contains: "products/{product:slug}"
  key_links:
    - from: "routes/web.php"
      to: "app/Http/Controllers/Storefront/ProductController.php"
      via: "Route::get('/products/{product:slug}')"
      pattern: "Route::get.*products.*ProductController"
    - from: "resources/views/storefront/products/show.blade.php"
      to: "app/Models/Product.php"
      via: "Blade displays product data"
      pattern: "product->name|product->price"
---

<objective>
Build customer-facing storefront with browsable product catalog using existing HTML design.

Purpose: Deliver core browsing experience - homepage, category pages, product listings, and product detail pages. Integrate existing Tailwind HTML design (generated-page.html) into Laravel Blade templates while maintaining responsive design.

Output: Working storefront where customers can browse categories, view product lists, and see detailed product pages with specifications.
</objective>

<execution_context>
@C:\Users\user\Desktop\mi_tech\.planning\workflows\execute-plan.md
@C:\Users\user\Desktop\mi_tech\.planning\templates\summary.md
</execution_context>

<context>
@C:\Users\user\Desktop\mi_tech\.planning\PROJECT.md
@C:\Users\user\Desktop\mi_tech\.planning\ROADMAP.md
@C:\Users\user\Desktop\mi_tech\.planning\STATE.md
@C:\Users\user\Desktop\mi_tech\.planning\research\ARCHITECTURE.md

# Reference existing HTML design for integration
@C:\Users\user\Desktop\mi_tech\generated-page.html
</context>

<tasks>

<task type="auto">
  <name>Create storefront controllers with SEO-friendly routing</name>
  <files>
    routes/web.php
    app/Http/Controllers/Storefront/HomeController.php
    app/Http/Controllers/Storefront/ProductController.php
    app/Http/Controllers/Storefront/CategoryController.php
  </files>
  <action>
    1. Define SEO-friendly routes in routes/web.php:
       ```php
       use App\Http\Controllers\Storefront\{HomeController, ProductController, CategoryController};

       // Public storefront routes
       Route::get('/', [HomeController::class, 'index'])->name('home');
       Route::get('/categories/{category:slug}', [CategoryController::class, 'show'])->name('category.show');
       Route::get('/products', [ProductController::class, 'index'])->name('products.index');
       Route::get('/products/{product:slug}', [ProductController::class, 'show'])->name('product.show');

       // Legacy fallback for ID-based URLs (301 redirect to slug)
       Route::get('/p/{id}', function ($id) {
           $product = Product::findOrFail($id);
           return redirect(route('product.show', $product), 301);
       })->name('product.legacy');
       ```

       CRITICAL: Using {product:slug} enables route model binding by slug (addresses Pitfall #8: SEO-hostile URLs)
       CRITICAL: Legacy ID route ensures non-breaking URLs if old links exist

    2. Create HomeController (app/Http/Controllers/Storefront/HomeController.php):
       ```php
       namespace App\Http\Controllers\Storefront;

       use App\Http\Controllers\Controller;
       use App\Models\Product;
       use App\Models\Category;

       class HomeController extends Controller
       {
           public function index()
           {
               // Popular products (view_count or created_at for new products)
               $popularProducts = Product::where('is_active', true)
                   ->where('stock', '>', 0)
                   ->orderBy('view_count', 'desc')
                   ->limit(8)
                   ->get();

               // Active categories
               $categories = Category::where('is_active', true)
                   ->withCount('products')
                   ->get();

               return view('storefront.home', compact('popularProducts', 'categories'));
           }
       }
       ```

    3. Create ProductController (app/Http/Controllers/Storefront/ProductController.php):
       ```php
       namespace App\Http\Controllers\Storefront;

       use App\Http\Controllers\Controller;
       use App\Models\Product;
       use Illuminate\Http\Request;

       class ProductController extends Controller
       {
           public function index(Request $request)
           {
               $query = Product::where('is_active', true)
                   ->with('categories'); // Prevent N+1 queries

               // Basic pagination (addresses Pitfall #6: loading all products)
               $products = $query->paginate(20);

               return view('storefront.products.index', compact('products'));
           }

           public function show(Product $product)
           {
               // Eager load relationships to avoid N+1
               $product->load(['categories', 'attributes']);

               // Increment view count for popularity tracking
               $product->increment('view_count');

               return view('storefront.products.show', compact('product'));
           }
       }
       ```

       CRITICAL: Eager loading prevents N+1 query problem (Anti-pattern from ARCHITECTURE.md)
       CRITICAL: Pagination prevents loading all products (Performance trap from PITFALLS.md)

    4. Create CategoryController (app/Http/Controllers/Storefront/CategoryController.php):
       ```php
       namespace App\Http\Controllers\Storefront;

       use App\Http\Controllers\Controller;
       use App\Models\Category;
       use Illuminate\Http\Request;

       class CategoryController extends Controller
       {
           public function show(Category $category)
           {
               // Get products in this category with eager loading
               $products = $category->products()
                   ->where('is_active', true)
                   ->where('stock', '>', 0)
                   ->with('categories')
                   ->paginate(20);

               return view('storefront.categories.show', compact('category', 'products'));
           }
       }
       ```

    Why this approach:
    - Route model binding by slug (not ID) provides SEO-friendly URLs
    - Eager loading (.with()) prevents N+1 query issues
    - Pagination (20 items) prevents performance degradation
    - Legacy ID route provides backward compatibility
    - View count tracking enables "popular products" feature
  </action>
  <verify>
    ```bash
    # Verify routes registered
    php artisan route:list | grep -E "(product|category|home)"

    # Test route model binding works with slug
    php artisan tinker --execute="
    \$product = Product::first();
    echo route('product.show', \$product);
    "

    # Verify controllers exist
    ls app/Http/Controllers/Storefront/
    ```
  </verify>
  <done>
    - Routes defined with SEO-friendly slug-based URLs
    - HomeController shows popular products and categories
    - ProductController has index (list) and show (detail) actions
    - CategoryController filters products by category
    - All controllers use eager loading to prevent N+1 queries
    - Route model binding works with Product/Category slugs
  </done>
</task>

<task type="auto">
  <name>Create Blade templates integrating existing HTML design</name>
  <files>
    resources/views/layouts/app.blade.php
    resources/views/storefront/home.blade.php
    resources/views/storefront/products/index.blade.php
    resources/views/storefront/products/show.blade.php
    resources/views/storefront/categories/show.blade.php
    resources/views/components/product-card.blade.php
  </files>
  <action>
    1. Extract layout structure from generated-page.html and create app.blade.php:
       - Parse generated-page.html for <head> section (meta tags, Tailwind CSS)
       - Extract header/navigation structure
       - Extract footer structure
       - Create @yield('content') section for page-specific content
       - Ensure Tailwind CDN or compiled CSS is included
       - Add viewport meta tag for responsive design (UI-02, UI-03, UI-04)

    2. Create home.blade.php:
       ```blade
       @extends('layouts.app')

       @section('content')
       <section class="container mx-auto px-4 py-8">
           <h1 class="text-3xl font-bold mb-6">Популярные товары</h1>

           <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
               @foreach($popularProducts as $product)
                   <x-product-card :product="$product" />
               @endforeach
           </div>
       </section>

       <section class="container mx-auto px-4 py-8">
           <h2 class="text-2xl font-bold mb-6">Категории</h2>

           <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
               @foreach($categories as $category)
                   <a href="{{ route('category.show', $category) }}"
                      class="p-4 border rounded hover:shadow-lg transition">
                       <h3 class="font-semibold">{{ $category->name }}</h3>
                       <p class="text-sm text-gray-600">{{ $category->products_count }} товаров</p>
                   </a>
               @endforeach
           </div>
       </section>
       @endsection
       ```

    3. Create product-card.blade.php component:
       ```blade
       @props(['product'])

       <div class="border rounded-lg overflow-hidden hover:shadow-lg transition">
           <a href="{{ route('product.show', $product) }}">
               @if($product->main_image)
                   <img src="{{ asset('storage/' . $product->main_image) }}"
                        alt="{{ $product->name }}"
                        class="w-full h-48 object-cover"
                        loading="lazy">
               @else
                   <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                       <span class="text-gray-400">No image</span>
                   </div>
               @endif

               <div class="p-4">
                   <h3 class="font-semibold mb-2">{{ $product->name }}</h3>

                   <div class="flex items-baseline gap-2">
                       <span class="text-2xl font-bold text-orange-600">
                           {{ number_format($product->price / 100, 0) }} сом
                       </span>

                       @if($product->old_price)
                           <span class="text-sm line-through text-gray-500">
                               {{ number_format($product->old_price / 100, 0) }} сом
                           </span>
                       @endif
                   </div>

                   @if($product->stock > 0)
                       <p class="text-sm text-green-600 mt-2">В наличии</p>
                   @else
                       <p class="text-sm text-red-600 mt-2">Нет в наличии</p>
                   @endif
               </div>
           </a>
       </div>
       ```

       CRITICAL: Price division by 100 converts cents to KGS (matches integer storage strategy)
       CRITICAL: loading="lazy" on images for performance (addresses PERF-01)

    4. Create products/show.blade.php (product detail page):
       ```blade
       @extends('layouts.app')

       @section('title', $product->meta_title ?? $product->name . ' - Mi Tech Store')
       @section('meta_description', $product->meta_description ?? $product->description)

       @section('content')
       <div class="container mx-auto px-4 py-8">
           <nav class="text-sm text-gray-600 mb-4">
               <a href="/" class="hover:underline">Главная</a>
               @foreach($product->categories as $category)
                   / <a href="{{ route('category.show', $category) }}" class="hover:underline">{{ $category->name }}</a>
               @endforeach
               / <span>{{ $product->name }}</span>
           </nav>

           <div class="grid md:grid-cols-2 gap-8">
               <!-- Product Images -->
               <div>
                   <img src="{{ asset('storage/' . $product->main_image) }}"
                        alt="{{ $product->name }}"
                        class="w-full rounded-lg mb-4">

                   @if($product->images)
                       <div class="grid grid-cols-4 gap-2">
                           @foreach($product->images as $image)
                               <img src="{{ asset('storage/' . $image) }}"
                                    alt="{{ $product->name }}"
                                    class="w-full h-20 object-cover rounded cursor-pointer hover:opacity-75">
                           @endforeach
                       </div>
                   @endif
               </div>

               <!-- Product Info -->
               <div>
                   <h1 class="text-3xl font-bold mb-4">{{ $product->name }}</h1>

                   <div class="flex items-baseline gap-3 mb-6">
                       <span class="text-4xl font-bold text-orange-600">
                           {{ number_format($product->price / 100, 0) }} сом
                       </span>

                       @if($product->old_price)
                           <span class="text-xl line-through text-gray-500">
                               {{ number_format($product->old_price / 100, 0) }} сом
                           </span>
                           <span class="bg-red-500 text-white px-2 py-1 rounded text-sm">
                               -{{ round((($product->old_price - $product->price) / $product->old_price) * 100) }}%
                           </span>
                       @endif
                   </div>

                   <div class="mb-6">
                       @if($product->stock > 0)
                           <p class="text-green-600 font-semibold">✓ В наличии ({{ $product->stock }} шт.)</p>
                       @else
                           <p class="text-red-600 font-semibold">Нет в наличии</p>
                       @endif
                   </div>

                   <div class="prose max-w-none mb-6">
                       <h2 class="text-xl font-semibold mb-2">Описание</h2>
                       <p class="text-gray-700">{{ $product->description }}</p>
                   </div>

                   @if($product->specifications)
                       <div class="mb-6">
                           <h2 class="text-xl font-semibold mb-3">Характеристики</h2>
                           <table class="w-full">
                               @foreach($product->specifications as $key => $value)
                                   <tr class="border-b">
                                       <td class="py-2 text-gray-600">{{ $key }}</td>
                                       <td class="py-2 font-semibold">{{ $value }}</td>
                                   </tr>
                               @endforeach
                           </table>
                       </div>
                   @endif

                   <!-- Placeholder for cart button (Phase 2) -->
                   <button disabled class="w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-semibold cursor-not-allowed">
                       Корзина появится в Phase 2
                   </button>
               </div>
           </div>
       </div>
       @endsection
       ```

       CRITICAL: Breadcrumb navigation for UX and SEO
       CRITICAL: Meta tags in @section for SEO (addresses SEO-01)
       CRITICAL: Responsive grid (md:grid-cols-2) for mobile/tablet/desktop

    5. Create products/index.blade.php and categories/show.blade.php:
       - Similar grid layout using product-card component
       - Pagination links: {{ $products->links() }}
       - Filter placeholder for Phase 1 Plan 3

    6. Ensure responsive design:
       - Use Tailwind responsive classes: sm:, md:, lg:
       - Test breakpoints: mobile (320px), tablet (768px), desktop (1024px)
       - Verify viewport meta tag in layout: <meta name="viewport" content="width=device-width, initial-scale=1">

    Why this approach:
    - Component-based design (product-card) for reusability
    - Tailwind CSS from existing design maintained
    - Price display logic centralized (cents → KGS conversion)
    - Lazy loading images for performance
    - Breadcrumbs and meta tags for SEO
    - Responsive grid system for all device sizes
  </action>
  <verify>
    ```bash
    # Verify views exist
    ls resources/views/storefront/

    # Verify layout includes Tailwind
    grep -i "tailwind" resources/views/layouts/app.blade.php

    # Test rendering (requires seeded data)
    php artisan serve &
    curl http://localhost:8000 | grep -i "популярные"

    # Verify responsive meta tag
    grep "viewport" resources/views/layouts/app.blade.php
    ```
  </verify>
  <done>
    - Layout extracted from generated-page.html with header/footer
    - Homepage displays popular products and category grid
    - Product detail page shows images, price, specs, stock status
    - Product card component reusable across views
    - All views use Tailwind CSS classes from existing design
    - Responsive design works on mobile/tablet/desktop
    - Breadcrumb navigation on product pages
    - Lazy loading enabled on images
  </done>
</task>

<task type="auto">
  <name>Create database seeders with sample Xiaomi products</name>
  <files>
    database/seeders/CategorySeeder.php
    database/seeders/ProductSeeder.php
    database/seeders/DatabaseSeeder.php
  </files>
  <action>
    1. Create CategorySeeder with Xiaomi categories:
       ```php
       use App\Models\Category;

       public function run()
       {
           $categories = [
               [
                   'name' => 'Смартфоны',
                   'description' => 'Флагманские и бюджетные смартфоны Xiaomi',
                   'meta_title' => 'Смартфоны Xiaomi - купить в Бишкеке',
                   'is_active' => true,
               ],
               [
                   'name' => 'Ноутбуки',
                   'description' => 'Ноутбуки Xiaomi для работы и учебы',
                   'meta_title' => 'Ноутбуки Xiaomi - официальный магазин',
                   'is_active' => true,
               ],
               [
                   'name' => 'Умный дом',
                   'description' => 'Устройства для умного дома Xiaomi',
                   'meta_title' => 'Xiaomi умный дом - гаджеты и аксессуары',
                   'is_active' => true,
               ],
               [
                   'name' => 'Аудио',
                   'description' => 'Наушники и колонки Xiaomi',
                   'is_active' => true,
               ],
           ];

           foreach ($categories as $category) {
               Category::create($category);
           }
       }
       ```

    2. Create ProductSeeder with realistic Xiaomi products:
       ```php
       use App\Models\{Product, Category, ProductAttribute};

       public function run()
       {
           $smartphones = Category::where('name', 'Смартфоны')->first();
           $smartHome = Category::where('name', 'Умный дом')->first();

           $products = [
               [
                   'name' => 'Xiaomi 14 Pro',
                   'description' => 'Флагманский смартфон с процессором Snapdragon 8 Gen 3, камерой 50MP и экраном AMOLED 120Hz',
                   'price' => 7999900, // 79,999 KGS in cents
                   'old_price' => 8999900,
                   'stock' => 15,
                   'sku' => 'XM-14-PRO-BK-256',
                   'specifications' => [
                       'Процессор' => 'Snapdragon 8 Gen 3',
                       'Память' => '12GB RAM + 256GB ROM',
                       'Камера' => '50MP основная, 50MP телефото, 50MP широкоугольная',
                       'Экран' => '6.73" AMOLED 120Hz',
                       'Батарея' => '4880 mAh, 120W быстрая зарядка',
                   ],
                   'is_active' => true,
                   'categories' => [$smartphones->id],
                   'attributes' => [
                       ['key' => 'memory', 'value' => '256GB'],
                       ['key' => 'color', 'value' => 'Black'],
                       ['key' => 'ram', 'value' => '12GB'],
                   ],
               ],
               [
                   'name' => 'Redmi Note 13 Pro',
                   'description' => 'Смартфон среднего класса с отличной камерой и большой батареей',
                   'price' => 2999900, // 29,999 KGS
                   'stock' => 30,
                   'sku' => 'RN-13-PRO-BL-128',
                   'specifications' => [
                       'Процессор' => 'Snapdragon 7s Gen 2',
                       'Память' => '8GB RAM + 128GB ROM',
                       'Камера' => '200MP основная',
                       'Экран' => '6.67" AMOLED 120Hz',
                       'Батарея' => '5000 mAh',
                   ],
                   'is_active' => true,
                   'categories' => [$smartphones->id],
                   'attributes' => [
                       ['key' => 'memory', 'value' => '128GB'],
                       ['key' => 'color', 'value' => 'Blue'],
                       ['key' => 'ram', 'value' => '8GB'],
                   ],
               ],
               [
                   'name' => 'Mi Smart Band 8',
                   'description' => 'Фитнес-браслет с мониторингом здоровья',
                   'price' => 399900, // 3,999 KGS
                   'stock' => 50,
                   'sku' => 'MI-BAND-8-BK',
                   'specifications' => [
                       'Экран' => '1.62" AMOLED',
                       'Водозащита' => '5 ATM',
                       'Батарея' => 'До 16 дней',
                       'Датчики' => 'Пульс, SpO2, сон',
                   ],
                   'is_active' => true,
                   'categories' => [$smartHome->id],
                   'attributes' => [
                       ['key' => 'color', 'value' => 'Black'],
                       ['key' => 'screen_size', 'value' => '1.62"'],
                   ],
               ],
           ];

           foreach ($products as $productData) {
               $categories = $productData['categories'];
               $attributes = $productData['attributes'] ?? [];
               unset($productData['categories'], $productData['attributes']);

               $product = Product::create($productData);
               $product->categories()->attach($categories);

               // Create ProductAttribute records for filtering (Plan 01-03)
               foreach ($attributes as $attr) {
                   ProductAttribute::create([
                       'product_id' => $product->id,
                       'key' => $attr['key'],
                       'value' => $attr['value'],
                   ]);
               }
           }
       }
       ```

       CRITICAL: Explicit ProductAttribute::create() calls ensure actual attribute data exists.
       Plan 01-03 filtering requires real ProductAttribute records, not just specifications JSON.

    3. Update DatabaseSeeder to call both seeders:
       ```php
       public function run()
       {
           $this->call([
               AdminUserSeeder::class,
               CategorySeeder::class,
               ProductSeeder::class,
           ]);
       }
       ```

    4. Run seeders:
       ```bash
       php artisan db:seed
       ```

    Why this approach:
    - Realistic Xiaomi product data for testing
    - Price in cents (79999 KGS = 7999900 cents)
    - Specifications as JSON array (display only)
    - ProductAttribute records for filtering (Plan 01-03 requirement)
    - SKU format: BRAND-MODEL-COLOR-STORAGE
    - Category relationships attached via pivot table
  </action>
  <verify>
    ```bash
    # Run seeder
    php artisan db:seed

    # Verify data
    php artisan tinker --execute="echo 'Categories: ' . Category::count(); echo 'Products: ' . Product::count();"

    # Verify relationships
    php artisan tinker --execute="
    \$product = Product::first();
    echo \$product->name . ' in categories: ' . \$product->categories->pluck('name')->join(', ');
    "

    # Verify slugs auto-generated
    php artisan tinker --execute="echo Product::first()->slug;"

    # Verify ProductAttribute records exist
    php artisan tinker --execute="
    \$product = Product::first();
    echo 'Attributes: ' . \$product->attributes->count();
    echo 'Memory: ' . \$product->attributes->where('key', 'memory')->first()->value;
    "
    ```
  </verify>
  <done>
    - CategorySeeder creates 4 Xiaomi categories with meta tags
    - ProductSeeder creates 3+ sample products with realistic data
    - Products have prices in cents, specifications, SKUs
    - Category-Product relationships established via pivot table
    - ProductAttribute records created for each product (memory, color, ram, etc.)
    - Slugs auto-generated by Spatie Sluggable
    - Data visible on storefront when accessed via browser
    - Attribute data ready for Plan 01-03 filtering
  </done>
</task>

</tasks>

<verification>
Full storefront verification:

```bash
# 1. Run development server
php artisan serve

# 2. Test homepage
curl http://localhost:8000 | grep -i "популярные товары"

# 3. Test product detail page
php artisan tinker --execute="
\$product = Product::first();
echo 'Visit: http://localhost:8000/products/' . \$product->slug;
"

# 4. Test category page
php artisan tinker --execute="
\$category = Category::first();
echo 'Visit: http://localhost:8000/categories/' . \$category->slug;
"

# 5. Verify responsive design (manual)
# Open browser to http://localhost:8000
# Test on mobile (320px), tablet (768px), desktop (1280px)
# Use browser DevTools responsive mode

# 6. Verify SEO elements
curl http://localhost:8000/products/xiaomi-14-pro | grep -E "(meta name|title)"

# 7. Check pagination works
curl http://localhost:8000/products?page=2
```

Expected results:
- Homepage displays popular products and categories
- Product detail page shows images, price, specs
- Category page filters products correctly
- URLs use slugs (not IDs)
- Pages responsive on all device sizes
- Meta tags present for SEO
</verification>

<success_criteria>
Storefront complete when:

1. **Routes & Controllers**:
   - SEO-friendly routes with slug-based URLs
   - HomeController displays popular products and categories
   - ProductController has working index and show actions
   - CategoryController filters products by category
   - Legacy ID route redirects to slug URLs

2. **Views & Design**:
   - Layout extracted from generated-page.html
   - Homepage with product grid and category links
   - Product detail page with images, price, specs, stock
   - Product card component reusable
   - Responsive design (mobile, tablet, desktop)
   - Breadcrumb navigation on product pages

3. **Data & SEO**:
   - Sample Xiaomi products seeded
   - Categories seeded with meta tags
   - Prices display in KGS (converted from cents)
   - Meta tags on product pages
   - Lazy loading enabled on images

4. **Performance**:
   - Eager loading prevents N+1 queries
   - Pagination limits products per page
   - No performance degradation with seeded data

5. **Manual Testing**:
   - Browse to http://localhost:8000 and see products
   - Click category and see filtered products
   - Click product and see full details
   - Test on mobile width (320px) - layout adapts
   - Test on desktop (1280px) - full grid visible
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-product-catalog/01-02-SUMMARY.md` documenting:
- Routes created and URL structure
- Controllers implemented
- Views/templates created
- Sample data seeded
- Any deviations from existing HTML design
- Key file paths for Plan 03 reference
</output>
